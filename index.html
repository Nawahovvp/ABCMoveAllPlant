<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบวิเคราะห์ ABC อะไหล่ (เวอร์ชันสมบูรณ์)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { font-family: "Prompt", sans-serif; margin: 0; background: #f5f7fa; padding: 10px; }
.container { max-width: 1920px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
h1 { text-align: center; color: white; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); font-size: 26px; margin: 0; }

.summary-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; padding: 16px; background: #f8f9fa; }
.card { flex: 1 1 140px; min-width: 140px; max-width: 180px; padding: 12px; border-radius: 14px; text-align: center; color: white; cursor: pointer; transition: all 0.3s; box-shadow: 0 6px 15px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.2); }
.card:hover { transform: translateY(-6px); }
.card-title { font-size: 12px; opacity: 0.95; margin-bottom: 6px; }
.card-value { font-size: 20px; font-weight: 900; margin: 6px 0; }
.card-count { font-size: 11px; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 3px 8px; }

.total-stock { background: linear-gradient(135deg, #2c3e50, #34495e); }
.order-items { background: linear-gradient(135deg, #e74c3c, #c0392b); }
.return-value { background: linear-gradient(135deg, #e67e22, #d35400); }
.monthly-withdrawal { background: linear-gradient(135deg, #8e44ad, #9b59b6); }
.stock-days { background: linear-gradient(135deg, #3498db, #2980b9); }
.after-stock-days { background: linear-gradient(135deg, #2ecc71, #27ae60); }
.abc-a { background: linear-gradient(135deg, #ff7675, #ff4757); }
.abc-b { background: linear-gradient(135deg, #ffeaa7, #ffd32a); }
.abc-c { background: linear-gradient(135deg, #a3daff, #74b9ff); }
.fast { background: linear-gradient(135deg, #55efc4, #00b894); }
.medium { background: linear-gradient(135deg, #ffeaa7, #fdcb6e); }
.slow { background: linear-gradient(135deg, #fab1a0, #e17055); }
.slowly { background: linear-gradient(135deg, #dfe6e9, #b2bec3); }
.dead { background: linear-gradient(135deg, #b2bec3, #636e72); }

.controls { padding: 20px; background: #fff; display: flex; flex-direction: column; gap: 15px; border-bottom: 1px solid #eee; }
.filter-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
.search-row { display: flex; gap: 15px; align-items: center; width: 100%; flex-wrap: wrap; }

.control-group { display: flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #f0f4ff, #e0eaff); padding: 12px 20px; border-radius: 16px; font-size: 14px; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.1); transition: all 0.3s; }
.control-group:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(102, 126, 234, 0.2); }
.control-icon { font-size: 18px; color: #667eea; }

label { font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 5px; }
select, input[type=number], input[type=text] { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccd1ff; font-size: 14px; background: white; transition: border 0.2s; width: 80px; }
select { width: 120px; }
input[type=text] { width: 250px; }
select:focus, input[type=number]:focus, input[type=text]:focus { border-color: #667eea; outline: none; }
.unit { font-size: 14px; color: #667eea; font-weight: 500; }

.export-btn { padding: 12px; background: linear-gradient(135deg, #27ae60, #1e8449); color: white; border: none; border-radius: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 6px 15px rgba(39,174,96,0.4); transition: all 0.3s; flex: 0 1 auto; margin-left: auto; }

.icon-btn {
  width: 40px; height: 40px; border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #3498db, #2980b9);
  color: #fff;
  display: inline-flex; align-items: center; justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
  transition: transform 0.2s, box-shadow 0.2s;
}
.icon-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 14px rgba(52, 152, 219, 0.6); }
.icon-btn i { font-size: 18px; }

.cart-main-btn { position: relative; }
#cartCountBadge {
  position: absolute; top: -4px; right: -4px;
  background: #e74c3c; color: #fff;
  border-radius: 999px;
  padding: 1px 6px;
  font-size: 10px;
  font-weight: bold;
}

/* =========================
   ✅ TABLE SCROLL + STICKY HEADER (ชัวร์)
   ========================= */

/* ให้ scroll เกิดที่กล่องตาราง */
.table-container{
  overflow: auto;
  max-height: calc(100vh - 320px);
  position: relative;
  padding: 0 16px;
}

/* ตาราง */
table{
  width: 100%;
  min-width: 1600px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  background: white;

  /* ★ สำคัญมากสำหรับ sticky: */
  border-collapse: separate; /* ห้าม collapse */
  border-spacing: 0;
}

/* ตรึงหัวตาราง */
thead{
  position: sticky;
  top: 0;
  z-index: 30;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
}

/* ตรึง th ทุกช่อง (กันหลุด/กันทะลุ) */
th{
  position: sticky;
  top: 0;
  z-index: 40;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;

  padding: 14px 10px;
  text-align: left;
  font-size: 13px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s;
  white-space: nowrap;
}
th:hover { background: rgba(255,255,255,0.1); }
.sort-icon { margin-left: 4px; font-size: 10px; }

/* แถว/เซลล์ */
tbody tr { transition: background 0.2s; border-bottom: 1px solid #eee; }
tbody tr:hover { background: #f0f8ff; }
tbody tr:nth-child(even) { background: #f8f9fa; }
td { padding: 12px 10px; font-size: 13px; text-align: left; }

/* badges */
.value { background: #667eea; color: white; padding: 4px 8px; border-radius: 8px; font-weight: bold; font-size: 12px; display: inline-block; }
.return-qty { background: #e74c3c; color: white; padding: 4px 8px; border-radius: 6px; display: inline-block; font-weight: bold; }

.moving-fast, .moving-medium, .moving-slow, .moving-slowly, .moving-dead {
  padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block;
}
.moving-fast { background: #d5f5e3; color: #1e8449; }
.moving-medium { background: #fef9e7; color: #d35400; }
.moving-slow { background: #fdecea; color: #c0392b; }
.moving-slowly { background: #f2f3f4; color: #616161; }
.moving-dead { background: #f0f0f0; color: #7f8c8d; }

.status-pending { background: #fef9e7; color: #d35400; padding: 4px 8px; border-radius: 6px; display: inline-block; font-weight: bold; }
.status-approved { background: #d5f5e3; color: #1e8449; padding: 4px 8px; border-radius: 6px; display: inline-block; font-weight: bold; }
.status-rejected { background: #fdecea; color: #c0392b; padding: 4px 8px; border-radius: 6px; display: inline-block; font-weight: bold; }
.status-other { background: #f2f3f4; color: #616161; padding: 4px 8px; border-radius: 6px; display: inline-block; font-weight: bold; }

.pagination { padding: 16px; text-align: center; background: #f8f9fa; font-size: 16px; font-weight: bold; color: #2c3e50; display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; }
.page-btn { padding: 8px 14px; background: white; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
.page-btn.active { background: #667eea; color: white; border: none; }
.page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.page-btn:hover:not(.active):not(:disabled) { background: #e9ecef; }

#loginModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100; }
.login-form { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; width: 300px; }
.login-form input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccd1ff; border-radius: 10px; }
.login-form button { padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; width: 100%; }
.login-form label { display: flex; align-items: center; justify-content: center; gap: 5px; margin: 10px 0; }
#loginError { color: red; margin-top: 10px; }

#menuBtn { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; color: white; cursor: pointer; }
#userMenu { position: absolute; top: 50px; right: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; text-align: left; }
#userMenu p { margin: 5px 0; }
#logoutBtn { padding: 8px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; }

.loader {
  --w:10ch; font-weight: bold; font-family: monospace; font-size: 30px; letter-spacing: var(--w);
  width: var(--w); overflow: hidden; white-space: nowrap;
  text-shadow: calc(-1*var(--w)) 0, calc(-2*var(--w)) 0, calc(-3*var(--w)) 0, calc(-4*var(--w)) 0,
               calc(-5*var(--w)) 0, calc(-6*var(--w)) 0, calc(-7*var(--w)) 0, calc(-8*var(--w)) 0, calc(-9*var(--w)) 0;
  animation: l16 2s infinite;
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;
}
.loader:before { content: "Loading..."; }
@keyframes l16 {
  20% { text-shadow: calc(-1*var(--w)) 0, calc(-2*var(--w)) 0 red, calc(-3*var(--w)) 0, calc(-4*var(--w)) 0 #ffa516, calc(-5*var(--w)) 0 #63fff4, calc(-6*var(--w)) 0, calc(-7*var(--w)) 0, calc(-8*var(--w)) 0 green, calc(-9*var(--w)) 0; }
  40% { text-shadow: calc(-1*var(--w)) 0, calc(-2*var(--w)) 0 red, calc(-3*var(--w)) 0 #e945e9, calc(-4*var(--w)) 0, calc(-5*var(--w)) 0 green, calc(-6*var(--w)) 0 orange, calc(-7*var(--w)) 0, calc(-8*var(--w)) 0 green, calc(-9*var(--w)) 0; }
  60% { text-shadow: calc(-1*var(--w)) 0 lightblue, calc(-2*var(--w)) 0, calc(-3*var(--w)) 0 #e945e9, calc(-4*var(--w)) 0, calc(-5*var(--w)) 0 green, calc(-6*var(--w)) 0, calc(-7*var(--w)) 0 yellow, calc(-8*var(--w)) 0 #ffa516, calc(-9*var(--w)) 0 red; }
  80% { text-shadow: calc(-1*var(--w)) 0 lightblue, calc(-2*var(--w)) 0 yellow, calc(-3*var(--w)) 0 #63fff4, calc(-4*var(--w)) 0 #ffa516, calc(-5*var(--w)) 0 red, calc(-6*var(--w)) 0, calc(-7*var(--w)) 0 grey, calc(-8*var(--w)) 0 #63fff4, calc(-9*var(--w)) 0; }
}

#backBtn { position: absolute; top: 20px; left: 20px; background: none; border: none; font-size: 24px; color: white; cursor: pointer; display: none; }

/* Filter ผู้รับคืน */
#responsibleFilterContainer {
  display: flex; align-items: center; gap: 10px;
  background: linear-gradient(135deg, #f0f4ff, #e0eaff);
  padding: 12px 20px; border-radius: 16px; font-size: 14px;
  box-shadow: 0 4px 10px rgba(102, 126, 234, 0.1);
  transition: all 0.3s;
}
#responsibleFilterContainer:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(102, 126, 234, 0.2); }
#responsibleFilter {
  min-width: 180px;
  padding: 10px 14px; border-radius: 10px;
  border: 1px solid #ccd1ff; font-size: 14px;
  background: white; transition: border 0.2s;
}
#responsibleFilter:focus { border-color: #667eea; outline: none; }

.responsible-cell { text-align: center; font-size: 13px; }
.responsible-user { background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 12px; display: inline-block; }

th.col-location, td.col-location,
th.col-shelf, td.col-shelf { display: none; }

th:nth-child(24), td:nth-child(24) { width: 100px; }
th:nth-child(25), td:nth-child(25) { width: 80px; }
th:nth-child(26), td:nth-child(26) { text-align: center; width: 140px; }

#controlsSection .filter-row .control-group:first-child { flex: 1 1 280px; min-width: 240px; }
#controlsSection .filter-row .control-group:first-child select { width: 100%; min-width: 220px; }

/* นวนคร = ส้ม */
.nava-orange { background: #f6b26b; color: #ffffff; padding: 4px 8px; border-radius: 6px; font-weight: bold; display: inline-block; }
/* นวนคร = 0 = แดง */
.nava-red { background:#cc0000; color:#fff; padding:4px 8px; border-radius:6px; font-weight:bold; display:inline-block; }

/* คงเหลือ = เขียว */
.stock-green { background: #6aa84f; color: #ffffff; padding: 4px 8px; border-radius: 6px; font-weight: bold; display: inline-block; }
/* คงเหลือ = 0 และ Moving = Fast = แดง */
.stock-red { background: #cc0000; color: #ffffff; padding: 4px 8px; border-radius: 6px; font-weight: bold; display: inline-block; }

/* Modal ตะกร้า */
.cart-modal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
.cart-modal-content {
  background: #ffffff;
  border-radius: 16px;
  max-width: 1000px;
  width: 95%;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  overflow: hidden;
}
.cart-modal-header, .cart-modal-footer {
  padding: 12px 18px;
  background: #f5f7fb;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
.cart-modal-header h2 { margin: 0; font-size: 18px; color: #2c3e50; }
.cart-modal-body { padding: 12px 18px 18px; overflow: auto; background: #fff; }

.cart-emp-input label { font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 6px; }
.cart-emp-input input { padding: 6px 10px; border-radius: 8px; border: 1px solid #ccd1ff; min-width: 160px; }

.cart-table { width: 100%; border-collapse: collapse; min-width: 600px; }
.cart-table th, .cart-table td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
.cart-table th { background: #2980b9; color: #ffffff; font-weight: 600; text-align: center; }

.cart-table input[type="number"] { width: 80px; padding: 4px 6px; border-radius: 6px; border: 1px solid #ccd1ff; text-align: right; }
.cart-empty { text-align: center; padding: 24px 0; color: #7f8c8d; }

.cart-emp-info { display: flex; flex-direction: column; font-size: 13px; margin-top: 4px; color: #2c3e50; }
.cart-emp-info span { line-height: 1.3; }

.order-equal { background: #2ecc71; color: #ffffff; padding: 4px 8px; border-radius: 6px; display: inline-block; font-weight: bold; }
.order-less  { background: #e74c3c; color: #ffffff; padding: 4px 8px; border-radius: 6px; display: inline-block; font-weight: bold; }
.order-more  { background: #2980b9; color: #ffffff; padding: 4px 8px; border-radius: 6px; display: inline-block; font-weight: bold; }

/* ==================== RESPONSIVE ==================== */
@media (max-width: 1200px) {
  body { padding: 0; }
  .container { max-width: 100%; border-radius: 0; box-shadow: none; }
  h1 { font-size: 22px; padding: 14px; }
  .summary-row { padding: 10px; gap: 8px; }
  .card { max-width: none; flex: 1 1 calc(50% - 10px); }
  .controls { padding: 12px; gap: 10px; }
  .control-group { width: 100%; justify-content: space-between; flex-wrap: wrap; }
  .control-group label { width: 100%; margin-bottom: 4px; }
  .control-group select,
  .control-group input[type=number],
  .control-group input[type=text] { width: 100% !important; }
  .export-btn { margin-left: 0; }
  .search-row, .filter-row { gap: 10px; }
  #responsibleFilterContainer { width: 100%; }
}

@media (max-width: 768px) {
  h1 { font-size: 18px; }
  .summary-row { flex-direction: column; align-items: stretch; }
  .card { flex: 1 1 100%; }
  .export-btn { width: 100%; justify-content: center; }
  .icon-btn { margin-left: 0; }
  table { min-width: 1000px; }
  th, td { padding: 8px 6px; font-size: 12px; }
}

@media (max-width: 480px) {
  h1 { font-size: 16px; padding: 10px; }
  .login-form { width: 260px; padding: 20px; }
  .page-btn { padding: 6px 10px; font-size: 12px; }
}
/* =========================
   ✅ HELP MODAL
   ========================= */
.help-modal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.65);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
  padding: 12px;
}

.help-content {
  width: min(980px, 96vw);
  max-height: 90vh;
  background: #fff;
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 18px 45px rgba(0,0,0,0.35);
  display: flex;
  flex-direction: column;
}

.help-header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  padding: 14px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.help-header h2 {
  margin: 0;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.help-close-btn {
  border: none;
  background: rgba(255,255,255,0.18);
  color: #fff;
  width: 40px; height: 40px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 18px;
}
.help-close-btn:hover { background: rgba(255,255,255,0.28); }

.help-body {
  padding: 16px 18px 18px;
  overflow: auto;
  color: #2c3e50;
}

.help-body h3 {
  margin: 14px 0 8px;
  font-size: 16px;
  color: #2c3e50;
}

.help-body p, .help-body li {
  font-size: 13.5px;
  line-height: 1.55;
  margin: 6px 0;
}

.help-pill {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  background: #eef2ff;
  color: #3949ab;
  font-weight: 700;
  font-size: 12px;
  margin-right: 6px;
}

.help-code {
  background: #0b1020;
  color: #e6edf3;
  border-radius: 12px;
  padding: 12px 14px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size: 12px;
  overflow: auto;
  margin: 10px 0;
}

.help-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
@media (max-width: 880px){
  .help-grid { grid-template-columns: 1fr; }
}
.help-card {
  background: #f8f9ff;
  border: 1px solid #e6eaff;
  border-radius: 14px;
  padding: 12px 14px;
}
.help-card b { color: #1f2d3d; 
}
.icon-btn.set-btn {
  background: linear-gradient(135deg, #27ae60, #1e8449);
  box-shadow: 0 4px 10px rgba(39,174,96,0.45);
}
.icon-btn.set-btn:hover {
  box-shadow: 0 6px 14px rgba(39,174,96,0.65);
}
    </style>
</head>
<body>
<div class="container">
    <h1>ABC Analysis & Smart Ordering System</h1>
    <button id="menuBtn" style="display: none;"><i class="fas fa-user-circle"></i></button>
    <div id="userMenu">
  <p id="userID"></p>
  <p id="userName"></p>

  <!-- ✅ ปุ่ม Help -->
  <button id="helpBtn" class="export-btn" style="width:100%;justify-content:center;margin:8px 0;background:linear-gradient(135deg,#3498db,#2980b9);">
    <i class="fas fa-circle-info"></i> Help
  </button>

  <button id="logoutBtn">Log out</button>
</div>

    <div class="loader" id="loader" style="display: none;"></div>
    <button id="backBtn"><i class="fas fa-arrow-left"></i></button>

    <!-- Plant Selection -->
    <div id="plantSelection" style="display: none; text-align: center; padding: 30px; background: linear-gradient(135deg, #f0f4ff, #e0eaff); border-radius: 20px; margin: 30px auto; max-width: 600px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
        <h2 style="color: #2c3e50; margin-bottom: 20px;">เลือกคลังสินค้า</h2>
        <div class="control-group" style="justify-content: center; margin: 0 auto; width: fit-content; display: flex; align-items: center; gap: 10px;">
            <label><i class="fas fa-industry control-icon"></i> Plant:</label>
            <select id="plantSelect" style="width: 250px;"></select>
            <button id="viewBtn" class="export-btn" style="padding: 10px 16px; height: fit-content;"><i class="fas fa-eye"></i> View</button>
        </div>
    </div>

    <!-- Cards -->
    <div class="summary-row" id="mainCardsSection" style="display:none;">
        <div class="card total-stock" id="cardTotalStock">
            <div class="card-title">มูลค่ารวม</div>
            <div class="card-value" id="totalStockValue">0.00</div>
            <div class="card-count" id="totalCount">0 รายการ</div>
        </div>
        <div class="card order-items" id="cardOrderItems">
            <div class="card-title">Order</div>
            <div class="card-value" id="orderItemCount">0</div>
            <div class="card-value" id="orderTotalValue">0.00</div>
        </div>
        <div class="card return-value" id="cardReturnValue">
            <div class="card-title">OverStock</div>
            <div class="card-value" id="returnValue">0.00</div>
            <div class="card-count" id="returnItemCount">0 รายการ</div>
        </div>
        <div class="card monthly-withdrawal" id="cardMonthlyWithdrawal">
            <div class="card-title">เบิก/เดือน</div>
            <div class="card-value" id="monthlyWithdrawalValue">0.00</div>
        </div>
        <div class="card stock-days" id="cardStockDays">
            <div class="card-title">Stock Days</div>
            <div class="card-value" id="stockDaysValue">0</div>
        </div>
        <div class="card after-stock-days" id="cardAfterStockDays">
            <div class="card-title">After Stock Days</div>
            <div class="card-value" id="afterStockDaysValue">0</div>
        </div>
    </div>

    <div class="summary-row" id="summarySection" style="display:none;">
        <div class="card abc-a" id="abcA"><div class="card-title">กลุ่ม A</div><div class="card-value" id="sumA">0.00</div><div class="card-count" id="countA">0 รายการ</div></div>
        <div class="card abc-b" id="abcB"><div class="card-title">กลุ่ม B</div><div class="card-value" id="sumB">0.00</div><div class="card-count" id="countB">0 รายการ</div></div>
        <div class="card abc-c" id="abcC"><div class="card-title">กลุ่ม C</div><div class="card-value" id="sumC">0.00</div><div class="card-count" id="countC">0 รายการ</div></div>
        <div class="card fast" id="cardFast"><div class="card-title">Fast Moving</div><div class="card-value" id="valFast">0.00</div><div class="card-count" id="countFast">0 รายการ</div></div>
        <div class="card medium" id="cardMedium"><div class="card-title">Medium</div><div class="card-value" id="valMedium">0.00</div><div class="card-count" id="countMedium">0 รายการ</div></div>
        <div class="card slow" id="cardSlow"><div class="card-title">Slow Moving</div><div class="card-value" id="valSlow">0.00</div><div class="card-count" id="countSlow">0 รายการ</div></div>
        <div class="card slowly" id="cardSlowly"><div class="card-title">Slowly Moving</div><div class="card-value" id="valSlowly">0.00</div><div class="card-count" id="countSlowly">0 รายการ</div></div>
        <div class="card dead" id="cardDead"><div class="card-title">Dead Stock</div><div class="card-value" id="valDead">0.00</div><div class="card-count" id="countDead">0 รายการ</div></div>
    </div>

    <div class="controls" id="controlsSection" style="display:none;">
        <div class="filter-row">
            <div class="control-group">
                <label><i class="fas fa-industry control-icon"></i> Plant:</label>
                <select id="plantFilter"><option value="">ทุก Plant</option></select>
            </div>
            <button id="updateBtn" class="icon-btn" title="Update data" style="display:none;">
                <i class="fas fa-database"></i>
            </button>
            <span id="lastUpdateLabel" style="font-size:12px;color:#555;margin-left:8px;"></span>
            <a id="uploadBtn" class="export-btn" href="#" target="_blank" style="display:none; flex: 0 1 auto; margin-left: 0;"><i class="fas fa-upload"></i> Upload</a>
            <div class="control-group">
                <label><i class="fas fa-clock control-icon"></i> Lead Time:</label>
                <input type="number" id="leadTimeDays" value="15"><span class="unit">วัน</span>
            </div>
            <div class="control-group">
                <label><i class="fas fa-shield-alt control-icon"></i> Safety:</label>
                <input type="number" id="safetyDays" value="5"><span class="unit">วัน</span>
            </div>
            <div class="control-group">
                <label><i class="fas fa-calendar-check control-icon"></i> ครอบคลุม:</label>
                <input type="number" id="coverDays" value="35"><span class="unit">วัน</span>
            </div>
        </div>
        <div class="search-row">
            <div class="control-group">
                <label><i class="fas fa-search control-icon"></i> ค้นหา:</label>
                <input type="text" id="searchInput" placeholder="Material หรือ Description">
            </div>
            <div id="responsibleFilterContainer">
                <label><i class="fas fa-user-check control-icon"></i> ผู้รับคืน:</label>
                <select id="responsibleFilter">
                    <option value="">ทุกคน</option>
                </select>
            </div>
            <div class="control-group">
                <label><i class="fas fa-filter control-icon"></i> Filter:Status:</label>
                <select id="statusFilter">
                    <option value="">ทุกสถานะ</option>
                    <option value="ไม่มีสถานะ">ไม่มีสถานะ</option>
                </select>
            </div>
            <div class="control-group">
    <label><i class="fas fa-balance-scale control-icon"></i> Option:</label>
    <select id="orderDiffFilter">
        <option value="">ทั้งหมด</option>
        <option value="less">น้อยกว่า</option>
        <option value="equal">เท่ากัน</option>
        <option value="more">มากกว่า</option>
        <option value="nav0">นวนคร = 0</option>
        <option value="actualgt0">สั่งจริง > 0</option>
        <option value="navgt0">นวนคร > 0</option>
    </select>
</div>

            <!-- ★ ปุ่มตะกร้ารวม -->
           <button class="icon-btn cart-main-btn" id="cartMainBtn" title="ตะกร้ารวม">
    <i class="fas fa-shopping-cart"></i>
    <span id="cartCountBadge">0</span>
</button>

<button class="icon-btn" id="cartClearBtn" title="ล้างตะกร้า">
    <i class="fas fa-trash"></i>
</button>

<!-- ✅ ปุ่ม Set (ทรงเดียวกับล้างตะกร้า) -->
<button class="icon-btn set-btn" id="setActualBtn" title="Set = แนะนำสั่ง">
    <i class="fas fa-check"></i>
</button>


<button class="export-btn" id="exportBtn">
    <i class="fas fa-file-export"></i> Export
</button>


    <div class="table-container" id="tableSection" style="display:none;">
        <table id="dataTable">
            <thead>
            <tr id="tableHeader">
  <th style="width:50px;" title="เพิ่มรายการเข้า “ตะกร้า” เพื่อพิมพ์/สรุปการเบิก">Cart</th>

  <th data-sort="Plant" title="รหัสคลังสินค้า (Plant) ที่กำลังดูข้อมูล">
    Plant <i class="fas fa-sort sort-icon"></i>
  </th>

  <th data-sort="Material" title="รหัสอะไหล่/วัสดุ (Material Code)">
    Material <i class="fas fa-sort sort-icon"></i>
  </th>

  <th title="ชื่อ/รายละเอียดอะไหล่จาก SAP (Material description)">รายการอะไหล่</th>

  <th title="ตำแหน่งจัดเก็บ (Storage bin) จากข้อมูลคลัง">Storage bin</th>

  <th data-sort="Unit" title="หน่วยนับของวัสดุ (Base Unit of Measure เช่น Pc)">
    หน่วย
  </th>

  <th data-sort="Navanakorn"
      title="จำนวนคงเหลือของ Material เดียวกันในคลังนวนคร (Plant 0301) เพื่อดูว่าคลังกลางมีของไหม">
    นวนคร
  </th>

  <th data-sort="Unrestricted"
      title="คงเหลือใช้งานได้ (Unrestricted stock) ของคลังที่กำลังดู">
    คงเหลือ <i class="fas fa-sort sort-icon"></i>
  </th>

  <th data-sort="Value"
      title="มูลค่าสต๊อก: ถ้ามี AvgVal => คงเหลือ×AvgVal, ถ้าไม่มีใช้ Value Unrestricted จาก SAP">
    มูลค่า <i class="fas fa-sort sort-icon"></i>
  </th>

  <th data-sort="Qty6Month"
      title="ยอดเบิกย้อนหลัง 6 เดือน (จาก MoveAllsum). ถ้าไม่มีจะประมาณจาก 4M×1.5">
    6M
  </th>

  <th data-sort="Qty4Month"
      title="ยอดเบิกย้อนหลัง 4 เดือน (ฐานหลักคำนวณ Avg/Day, Avg/Month)">
    4M
  </th>

  <th data-sort="AvgMonthly"
      title="ค่าเฉลี่ยการเบิกต่อเดือน (AvgM) = Qty4Month ÷ 4">
    AvgM
  </th>

  <th data-sort="ThirtyDay"
      title="ยอดเบิกจริงใน 30 วันล่าสุด (ช่วยจับความต้องการล่าสุด)">
    30Day
  </th>

  <th data-sort="Mean"
      title="ค่าใช้ฐานเปรียบเทียบความต้องการ: Mean = max(30Day, AvgM) (เลือกค่าที่มากกว่าเพื่อกันของขาด)">
    Mean
  </th>

  <th data-sort="SafetyStock"
      title="Safety Stock = AvgDailyUse × SafetyDays (SafetyDays มาจากช่อง Safety)">
    Safety
  </th>

  <th data-sort="ROP"
      title="Reorder Point (ROP) = (AvgDailyUse × LeadTimeDays) + SafetyStock">
    ROP <i class="fas fa-sort sort-icon"></i>
  </th>

  <th data-sort="DOS"
      title="Days of Stock (DOS) = คงเหลือ ÷ AvgDailyUse (ถ้า AvgDailyUse=0 จะแสดง 'มาก')">
    DOS
  </th>

  <th data-sort="RecommendedOrder"
      title="จำนวนแนะนำสั่ง: ถ้าคงเหลือ < ROP => (AvgDailyUse×CoverDays) - คงเหลือ แล้วปัดตาม Pack (MultiplyUnit)">
    แนะนำสั่ง <i class="fas fa-sort sort-icon"></i>
  </th>

  <th title="จำนวนสั่งจริงที่ผู้ใช้ปรับเอง (ระบบจะจำค่าไว้ในเครื่องด้วย LocalStorage)">สั่งจริง</th>

  <th title="หมายเหตุเพิ่มเติมจากข้อมูล mainsap (ใช้ช่วยตัดสินใจ)">หมายเหตุ</th>

  <th data-sort="MultiplyUnit"
      title="Pack/Package: จำนวนต่อแพ็คสำหรับปัดการสั่ง (เช่น 10 = สั่งเป็น 10/20/30)">
    Package
  </th>

  <th data-sort="Product" title="กลุ่ม/ประเภทสินค้า (Product Group) จาก mainsap">
    Product
  </th>

  <th data-sort="ABCValue"
      title="ABC ตามมูลค่าสะสม (Pareto): A≤70%, B≤90%, C>90% (คำนวณจาก Value/Order/Return ตามโหมด)">
    ABC
  </th>

  <th data-sort="Moving"
      title="ความเร็วการเคลื่อนไหวจาก AvgM: Dead=0, Slowly<0.7, Slow<12, Medium<30, Fast>=30">
    Moving
  </th>

  <th data-sort="ReturnQty"
      title="จำนวนส่งคืนได้ = max(0, คงเหลือ - KeepQty). KeepQty คำนวณจาก Moving + ABC ตามสูตรใน calculateKeepQty()">
    จำนวนส่งคืน
  </th>

  <th data-sort="CumPercent"
      title="เปอร์เซ็นต์มูลค่าสะสมของรายการนั้นในลำดับการจัด ABC (ใช้แบ่ง A/B/C)">
    %สะสม <i class="fas fa-sort sort-icon"></i>
  </th>

  <th class="col-location" title="Location จากข้อมูลจัดเก็บ (ถ้ามี) หรือใช้ Storage bin แทน">Location</th>
  <th class="col-shelf" title="Shelf = อักษร/รหัส 3 ตัวแรกของ Location (ใช้ map หาเจ้าของ)">Shelf</th>

  <th title="ผู้รับคืน/ผู้ดูแล Shelf (map จาก Shelf → UserID → ชื่อ)">ผู้รับคืน</th>

  <th data-sort="Status" title="สถานะวัสดุ/คำสั่ง (ดึงจากชีท Orders เช่น pending/approved)">
    Status
  </th>
</tr>
            </thead>
            <tbody id="dataList"></tbody>
        </table>
    </div>

    <div class="pagination" id="pagination" style="display:none;"></div>
</div>

<!-- Login Modal -->
<div id="loginModal" style="display:none;">
    <div class="login-form">
        <h2>Login</h2>
        <input type="text" id="idUserInput" placeholder="IDUser">
        <input type="password" id="passwordInput" placeholder="Password">
        <label><input type="checkbox" id="rememberMe"> จดจำฉัน</label>
        <button id="loginBtn">เข้าสู่ระบบ</button>
        <div id="loginError"></div>
    </div>
</div>
<!-- =========================
     ✅ HELP MODAL (อธิบายโปรแกรม)
     ========================= -->
<div id="helpModal" class="help-modal">
  <div class="help-content">
    <div class="help-header">
      <h2><i class="fas fa-circle-info"></i> คู่มือระบบ ABC Analysis & Smart Ordering</h2>
      <button class="help-close-btn" id="helpCloseBtn" title="ปิด"><i class="fas fa-xmark"></i></button>
    </div>

    <div class="help-body">

      <div class="help-grid">
        <div class="help-card">
          <h3><span class="help-pill">เป้าหมาย</span></h3>
          <ul>
            <li><b>จัดกลุ่มอะไหล่ (ABC)</b> จากมูลค่ารวม เพื่อรู้ว่าอะไรสำคัญมาก (A) สำคัญรอง (B) และทั่วไป (C)</li>
            <li><b>วิเคราะห์การเคลื่อนไหว (Moving)</b> เพื่อแยก Fast/Medium/Slow/Dead</li>
            <li><b>คำนวณ “แนะนำสั่ง”</b> เพื่อกันของขาด (Stockout) และลดของเกิน (Overstock)</li>
            <li><b>ช่วยตัดสินใจ</b> ด้วย ROP, Safety Stock, DOS และตัวกรองต่าง ๆ</li>
          </ul>
        </div>

        <div class="help-card">
          <h3><span class="help-pill">ข้อมูลที่ใช้</span></h3>
          <ul>
            <li><b>Qty4Month</b> = ยอดเบิก 4 เดือน (ฐานหลัก 120 วัน)</li>
            <li><b>ThirtyDay</b> = ยอดเบิก 30 วันล่าสุด (สะท้อนสถานการณ์ปัจจุบัน)</li>
            <li><b>Unrestricted</b> = คงเหลือ</li>
            <li><b>AvgVal</b> = ราคาเฉลี่ยต่อชิ้น (ถ้ามีจะใช้คำนวณ Value ให้แม่น)</li>
            <li><b>MultiplyUnit</b> = Pack/หน่วยแพ็ค (ใช้ปัดจำนวนแนะนำสั่ง)</li>
          </ul>
        </div>
      </div>

      <h3>ความหมายหัวคอลัมน์สำคัญ</h3>
      <ul>
        <li><b>AvgM</b> = เฉลี่ยต่อเดือนจาก 4 เดือน (Qty4Month ÷ 4)</li>
        <li><b>30Day</b> = ยอดเบิก 30 วันล่าสุด</li>
        <li><b>Mean</b> = “ค่าเฉลี่ยรายเดือนแบบถ่วงน้ำหนัก” (ผสม 4M และ 30Day เพื่อความนิ่ง + ทันสมัย)</li>
        <li><b>Safety</b> = Safety Stock (สำรองเพื่อกันผันผวน)</li>
        <li><b>ROP</b> = Reorder Point (จุดสั่งซื้อ)</li>
        <li><b>DOS</b> = Days of Supply (คงเหลือกินได้กี่วัน)</li>
        <li><b>แนะนำสั่ง</b> = จำนวนที่ระบบแนะนำ (พร้อมปัดตาม Pack)</li>
      </ul>

      <h3>สูตรคำนวณหลัก (ใช้ใน “แนะนำสั่ง”)</h3>

      <p><span class="help-pill">1) Avg ต่อวัน</span></p>
      <div class="help-code">
avg4mDaily  = Qty4Month / 120
avg30dDaily = ThirtyDay / 30
      </div>

      <p><span class="help-pill">2) Weighted AvgDailyUse (ถ่วงน้ำหนัก)</span></p>
      <p>ระบบ “ผสม” 4 เดือน (นิ่ง) + 30 วัน (สด) โดยน้ำหนักขึ้นกับ Moving และ ABC</p>
      <div class="help-code">
AvgDailyUse = (avg4mDaily * w4m) + (guarded30dDaily * w30)
      </div>

      <p><span class="help-pill">3) Outlier Guard (กัน 30Day พุ่งผิดปกติ)</span></p>
      <div class="help-code">
ถ้า avg30dDaily > avg4mDaily * limitMultiplier
ให้ใช้ guarded30dDaily = avg4mDaily * limitMultiplier
      </div>

      <p><span class="help-pill">4) Safety Stock / ROP / DOS</span></p>
      <div class="help-code">
SafetyStock = AvgDailyUse * safetyDaysEffective
ROP         = (AvgDailyUse * leadTime) + SafetyStock
DOS         = Unrestricted / AvgDailyUse
      </div>

      <p><span class="help-pill">5) แนะนำสั่ง (RecommendedOrder)</span></p>
      <p>ถ้า “คงเหลือ < ROP” → เติมให้ครอบคลุมจำนวนวัน “CoverDays”</p>
      <div class="help-code">
if (Unrestricted < ROP) {
  needed    = AvgDailyUse * coverDays
  recommend = needed - Unrestricted
} else {
  recommend = 0
}

ปัดตาม Pack:
recommend = ceil(recommend / MultiplyUnit) * MultiplyUnit
      </div>

      <h3>แนวคิด “ฉลาดขึ้น” ที่อยู่ในฟังก์ชันของคุณ</h3>
      <ul>
        <li><b>Seasonal Mode</b>: ถ้า 30Day สูงกว่า 4M มาก → เพิ่มน้ำหนัก 30Day ชั่วคราว (แต่มีเพดาน)</li>
        <li><b>Stockout Protection</b>: ถ้าคงเหลือ=0 และเป็น Fast/Medium → เพิ่ม safetyDays ชั่วคราวกันขาดช่วง</li>
        <li><b>Moving</b>: ตีความความเร็วจาก AvgM เพื่อให้ระบบเลือกน้ำหนัก w4m/w30 ที่เหมาะสม</li>
      </ul>

      <h3>อ่านค่า “แนะนำสั่ง” ยังไงให้ใช้งานจริง</h3>
      <ul>
        <li>ถ้าคุณเพิ่ม Lead Time / Safety / Cover มากขึ้น → แนะนำสั่งจะสูงขึ้น (กันขาดมากขึ้น)</li>
        <li>ถ้า MultiplyUnit (Pack) มาก → ระบบจะ “ปัดขึ้น” เพื่อให้สั่งได้จริงตามแพ็ค</li>
        <li>ถ้ารายการเป็น Slow/Slowly และ Mean/30Day = 0 → ระบบอาจตัดให้แนะนำสั่ง = 0 เพื่อกันของค้าง</li>
      </ul>

    </div>
  </div>
</div>

<!-- ★ Cart Modal -->
<div id="cartModal" class="cart-modal">
    <div class="cart-modal-content" id="cartModalPrintArea">
        <div class="cart-modal-header">
    <h2><i class="fas fa-shopping-cart"></i> ตะกร้าอะไหล่</h2>
    <div class="cart-emp-input">
        <label>
            รหัสพนักงาน:
            <input type="text" id="employeeCode" placeholder="กรอกรหัสพนักงาน">
        </label>
        <!-- ★ แสดงชื่อและทีมที่ดึงจาก Employee sheet -->
        <div class="cart-emp-info">
            <span id="employeeNameLabel"></span>
            <span id="employeeTeamLabel"></span>
        </div>
    </div>
</div>

        <div class="cart-modal-body">
            <table class="cart-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Material</th>
                        <th>รายการอะไหล่</th>
                        <th>Storage bin</th>
                        <th>จำนวน</th>
                        <th>Pack</th>
                    </tr>
                </thead>
                <tbody id="cartTableBody">
                    <!-- เติมด้วย JS -->
                </tbody>
            </table>
        </div>
        <div class="cart-modal-footer">
            <button class="export-btn" id="cartPrintBtn"><i class="fas fa-print"></i> Print</button>
            <button class="export-btn" id="cartCloseBtn" style="background:linear-gradient(135deg,#e74c3c,#c0392b);"><i class="fas fa-times"></i> ปิดหน้าต่าง</button>
        </div>
    </div>
</div>

<script>
let sortKey = "CumPercent", sortDir = "asc";
let allData = [], filteredData = [];
let mode = "all", abcFilter = "", movingFilter = "";
let currentPage = 1;
const rowsPerPage = 25;
let users = [];
let loggedUser = null;
let inventoryUrl;
let selectedPlant = "";


/* ★ ตะกร้า */
let cartItems = [];

const userSheetID = '1eqVoLsZxGguEbRCC5rdI4iMVtQ7CK4T3uXRdx8zE3uw';
const userSheetName = 'UserPlant';
const userUrl = `https://opensheet.elk.sh/${userSheetID}/${userSheetName}`;
const usageUrl = 'https://opensheet.elk.sh/1P8Frv1zvcuO3qt8seU-zMF0FV0TQHyKXLn9GNHVr6kI/MoveAllsum';
const mainsapUrl = 'https://opensheet.elk.sh/1CkfOIe2nDYBLs5aPGkPyZhOeqJkyS7UQ6tuMzxy-mfk/mainsap';
const avgValUrl = 'https://opensheet.elk.sh/1nwXDN6FjmXOHXzlxVv6y0Kv4peU9kjW3q20PAWsp6_4/Sheet1';
const statusUrl = 'https://opensheet.elk.sh/1yP1sq12fSXj00htJewUIugkQCaxA0smO2je7wtEISdw/Orders';

const locationUrl = 'https://opensheet.elk.sh/1x-B1xekpMm4p7fkKucvLjaewtp66uGIp8ZIxJJZAxMk/Sheet1';
const shelfUrl   = 'https://opensheet.elk.sh/1KhwMIVL-E3XDixbxLT3o-Qg57-hvy_DW0y-v5oNMWDk/Shelf';

let locationMap = new Map();
let shelfOwnerMap = new Map();

const employeeUrl = 'https://opensheet.elk.sh/1eqVoLsZxGguEbRCC5rdI4iMVtQ7CK4T3uXRdx8zE3uw/Employee';
let employees = [];
const inventoryUrls = {
    '0301': 'https://opensheet.elk.sh/1x-B1xekpMm4p7fkKucvLjaewtp66uGIp8ZIxJJZAxMk/Sheet1',
    '0304': 'https://opensheet.elk.sh/1miQgObvPdIocjf2Mwn-GZxRvDZy0R5gIl1zhxMWvM-E/Sheet1',
    '0307': 'https://opensheet.elk.sh/1C9vfwtdIO-XjHrDkmp5cUahjmcJ3vk8pTzhFCgHBg1Q/Sheet1',
    '0309': 'https://opensheet.elk.sh/1ntRtlRIndxgEZ3udnh7Nj8LSQiaUdAeAg5j8qd_z8sA/Sheet1',
    '0311': 'https://opensheet.elk.sh/1OKDdqLY_TOjjfLJ58xFiq-WHIDbMrxMcDho6FO5Rq8o/Sheet1',
    '0312': 'https://opensheet.elk.sh/1ilYbVsCqA1cSoUnZwwULCmPkdakobICkyq5JpBJyyAU/Sheet1',
    '0313': 'https://opensheet.elk.sh/12FSbkYSB1zi6xo2WGAsM0jFyp3IkIywLFVF0Zn2axpE/Sheet1',
    '0319': 'https://opensheet.elk.sh/1pYJsp3ZVSwQ1h_Ayqp3BrMTsm-ZtLREU03Qw5WUtgAw/Sheet1',
    '0320': 'https://opensheet.elk.sh/1V5uhH1wekza4FLN2VqtVBfgIA1sbTY_mqq4ohnTmW_M/Sheet1',
    '0326': 'https://opensheet.elk.sh/1gtZLR5Tm574o5xRbdrRm9yFzRukGx_UAzUnoah36cxQ/Sheet1',
    '0366': 'https://opensheet.elk.sh/1NtRsaxPkeNb4sAcTm-Tn4oN-o5F6z_56S1nhTg7kvBc/Sheet1',
    '0369': 'https://opensheet.elk.sh/13NYKhEWkWLLnA2DZZEP-zZEz2r33-roUDPMSWoFR3Qk/Sheet1'
};

const lastUpdateApiBase = 'https://script.google.com/macros/s/AKfycbxwPojlkzA-QBknRpN6GIiuwxJo5cyBsVGgXQwneGenfsvSz9YuzuoNf2ZsrtxoKypE3Q/exec';

const lastUpdateApiByPlant = {
    '0304': `${lastUpdateApiBase}?id=1miQgObvPdIocjf2Mwn-GZxRvDZy0R5gIl1zhxMWvM-E`,
    '0307': `${lastUpdateApiBase}?id=1C9vfwtdIO-XjHrDkmp5cUahjmcJ3vk8pTzhFCgHBg1Q`,
    '0309': `${lastUpdateApiBase}?id=1ntRtlRIndxgEZ3udnh7Nj8LSQiaUdAeAg5j8qd_z8sA`,
    '0311': `${lastUpdateApiBase}?id=1OKDdqLY_TOjjfLJ58xFiq-WHIDbMrxMcDho6FO5Rq8o`,
    '0312': `${lastUpdateApiBase}?id=1ilYbVsCqA1cSoUnZwwULCmPkdakobICkyq5JpBJyyAU`,
    '0313': `${lastUpdateApiBase}?id=12FSbkYSB1zi6xo2WGAsM0jFyp3IkIywLFVF0Zn2axpE`,
    '0319': `${lastUpdateApiBase}?id=1pYJsp3ZVSwQ1h_Ayqp3BrMTsm-ZtLREU03Qw5WUtgAw`,
    '0320': `${lastUpdateApiBase}?id=1V5uhH1wekza4FLN2VqtVBfgIA1sbTY_mqq4ohnTmW_M`,
    '0326': `${lastUpdateApiBase}?id=1gtZLR5Tm574o5xRbdrRm9yFzRukGx_UAzUnoah36cxQ`,
    '0366': `${lastUpdateApiBase}?id=1NtRsaxPkeNb4sAcTm-Tn4oN-o5F6z_56S1nhTg7kvBc`,
    '0369': `${lastUpdateApiBase}?id=13NYKhEWkWLLnA2DZZEP-zZEz2r33-roUDPMSWoFR3Qk`
};

const sheetIds = {};
Object.keys(inventoryUrls).forEach(plant => {
    const url = inventoryUrls[plant];
    const parts = url.split('/');
    sheetIds[plant] = parts[3];
});

const plantNames = {
    '0301': 'นวนคร',
    '0303': 'SA-สงขลา',
    '0304': 'พระราม 3',
    '0305': 'ราชบุรี',
    '0307': 'สุราษฎร์',
    '0309': 'นครราชสีมา',
    '0310': 'SA-อุดร 1',
    '0311': 'ศรีราชา',
    '0312': 'พิษณุโลก',
    '0313': 'ภูเก็ต',
    '0315': 'SA-อยุธยา',
    '0319': 'ขอนแก่น',
    '0318': 'คลังวัตถุดิบ',
    '0320': 'ลำปาง',
    '0322': 'SA-อุดร 2',
    '0323': 'SA-ลำลูกกา',
    '0324': 'SA-ปัตตานี',
    '0326': 'วิภาวดี 62',
    '0362': 'SA-หนองแขม',
    '0363': 'SA-ปากเกร็ด',
    '0364': 'SA-บางบัวทอง',
    '0365': 'SA-สมุทรปราการ',
    '0366': 'เชียงใหม่',
    '0367': 'SA-ฉะเชิงเทรา',
    '0368': 'SA-ร้อยเอ็ด',
    '0369': 'ระยอง'
};

function toNumber(v){return parseFloat((v||"0").toString().replace(/,/g,''))||0;}
function formatNumber(n){return Number(n).toLocaleString('th-TH');}
function formatCurrency(n){return Number(n).toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2});}
function formatShortCurrency(n){
    if(n>=1e9)return(n/1e9).toFixed(2)+" พันล้าน";
    if(n>=1e6)return(n/1e6).toFixed(2)+" M";
    if(n>=1e3)return(n/1e3).toFixed(2)+" K";
    return n.toFixed(2);
}

function getOwnerName(userId){
    switch(userId){
        case '7556706': return 'ทศพล แซ่เบ๊';
        case '7512395': return 'ประวิทย์ โชติสิทธิพงษ์';
        case '7513338': return 'อติคุณ  พันธุ์บุญเลิศ';
        case '7514198': return 'ทศพล  เหมือนสังข์';
        case '7617585': return 'กิตติเทพ หล้าแก้ว';
        case '7514499': return 'ธนพล ศรีทองกูล';
        case '7512147': return 'เสรีชัย สองนา';
        case '7512141': return 'อาทิตย์ มาทรง';
        case '7513235': return 'ฤทธิพงษ์ แจ้งวิจิตร';
        case '7512424': return 'พิพัฒน์ แตงอ่อน';
        case '7513032': return 'วิศรุต กางกรณ์';
        case '7832535': return 'ปรานต์ตะวัน พรมลี';
        case '7834952': return 'นพดล กกรัมย์';
        default: return userId||'';
    }
}

function calculateKeepQty(r){
    const avg=r.AvgMonthly;
    if(r.Moving==="Dead"||r.Moving==="Slowly")return 1;
    if(r.Moving==="Slow"&&r.ABCValue==="C")return Math.max(1,Math.round(avg*60));
    if(r.Moving==="Slow"&&r.ABCValue==="B")return Math.max(1,Math.round(avg*60));
    if(r.Moving==="Medium"&&r.ABCValue==="C")return Math.max(2,Math.round(avg*60));
    if(r.Moving==="Slow"&&r.ABCValue==="A")return Math.max(3,Math.round(avg*60));
    if(r.Moving==="Medium"&&r.ABCValue==="B")return Math.max(4,Math.round(avg*60));
    if(r.Moving==="Fast"&&r.ABCValue==="C")return Math.max(5,Math.round(avg*60));
    if(r.Moving==="Medium"&&r.ABCValue==="A")return Math.max(6,Math.round(avg*75));
    if(r.Moving==="Fast"&&r.ABCValue==="B")return Math.max(8,Math.round(avg*90));
    if(r.Moving==="Fast"&&r.ABCValue==="A")return Math.max(10,Math.round(avg*120));
    return Math.max(1,Math.round(avg*40));
}

/* ★ ฟังก์ชันตะกร้า */
function updateCartCount(){
    const badge = document.getElementById('cartCountBadge');
    if(!badge) return;
    badge.textContent = cartItems.length;
}

function addToCart(item){
   const exist = cartItems.find(x => x.Material === item.Material && x.StorageBin === item.StorageBin);
    if(exist){
        exist.Qty = (exist.Qty || 1) + 1;
    }else{
        cartItems.push({
            Material: item.Material,
            Description: item.Description,
            StorageBin: item.StorageBin,
            Qty: 1,
            Pack: 1
        });
    }
    updateCartCount();
}
/* ★ หา Employee ตามรหัสที่กรอก */
function updateEmployeeInfo(){
    const codeInput = document.getElementById('employeeCode');
    const nameLabel = document.getElementById('employeeNameLabel');
    const teamLabel = document.getElementById('employeeTeamLabel');
    if(!codeInput || !nameLabel || !teamLabel) return;

    const id = (codeInput.value || '').trim();
    if(!id){
        nameLabel.textContent = '';
        teamLabel.textContent = '';
        return;
    }

    // หา row ที่ IDRec ตรงกับรหัสพนักงาน
    const emp = employees.find(e => (e.IDRec || '').toString().trim() === id);

    if(emp){
        nameLabel.textContent = `ชื่อ: ${emp.Name || '-'}`;
        teamLabel.textContent = `ทีม: ${emp.Team || '-'}`;
    }else{
        nameLabel.textContent = 'ไม่พบรหัสพนักงานนี้';
        teamLabel.textContent = '';
    }
}

function renderCartTable(){
    const tbody = document.getElementById('cartTableBody');
    tbody.innerHTML = "";
    if(cartItems.length === 0){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = "cart-empty";
        td.textContent = "ยังไม่มีรายการในตะกร้า";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }
    cartItems.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${item.Material}</td>
            <td>${item.Description}</td>
            <td>${item.StorageBin}</td>
            <td></td>
            <td></td>
        `;
        const qtyInput = document.createElement('input');
        qtyInput.type = "number";
        qtyInput.min = "0";
        qtyInput.value = item.Qty ?? 1;
        qtyInput.addEventListener('input', () => {
            const v = parseFloat(qtyInput.value);
            item.Qty = isNaN(v) ? 0 : v;
        });

        const packInput = document.createElement('input');
        packInput.type = "number";
        packInput.min = "0";
        packInput.value = item.Pack ?? 1;
        packInput.addEventListener('input', () => {
            const v = parseFloat(packInput.value);
            item.Pack = isNaN(v) ? 0 : v;
        });

        tr.cells[4].appendChild(qtyInput);
        tr.cells[5].appendChild(packInput);
        tbody.appendChild(tr);
    });
}

function openCartModal(){
    renderCartTable();
    updateEmployeeInfo(); // ★ อัปเดตชื่อ/ทีมตามรหัสที่มีอยู่
    document.getElementById('cartModal').style.display = 'flex';
}

function closeCartModal(){
    document.getElementById('cartModal').style.display = 'none';
}
function clearCart(){
    cartItems = [];
    updateCartCount();
    // ถ้าเปิด modal อยู่ ให้รีเฟรชตารางในตะกร้าด้วย
    const cartModal = document.getElementById('cartModal');
    if(cartModal && cartModal.style.display === 'flex'){
        renderCartTable();
    }
}

function printCart() {

    // ✅ ใช้ cartItems โดยตรง
    if (!Array.isArray(cartItems) || cartItems.length === 0) {
        alert("ไม่มีรายการในตะกร้า");
        return;
    }

    // อ่านรหัสพนักงานจากช่องใน Modal
    var empCode = document.getElementById("employeeCode")
        ? document.getElementById("employeeCode").value.trim()
        : "";

    // หา Name & Team จาก employees (Sheet Employee)
    var empName = "";
    var empTeam = "";
    if (empCode && Array.isArray(employees)) {
        var emp = employees.find(function (e) {
            return (e.IDRec || "").toString().trim() === empCode;
        });
        if (emp) {
            empName = emp.Name || "";
            empTeam = emp.Team || "";
        }
    }

    // ✅ เตรียมข้อมูลให้ชื่อฟิลด์ตรงกับโค้ด template เดิม
    var dataForPrint = cartItems.map(function (item) {
        return {
            Material: item.Material || "",
            จำนวน: item.Qty ? parseInt(item.Qty) || 1 : 1,
            Pack: item.Pack ? item.Pack : "",
            IDช่าง: empCode,
            Serial: "-",                         // ไม่ใช้ Serial = TRUE แล้ว
            Description: item.Description || "",
            Storagebin: item.StorageBin || "",
            ชื่อช่าง: empName,
            Unit: "Pc",
            แผนก: empTeam
        };
    });

    // เปิดหน้าต่างใหม่
    var win = window.open("", "_blank", "width=1024,height=768");

    // แปลงข้อมูลเป็น JSON ปลอดภัย (กัน < กลายเป็น tag)
    var jsonText = JSON.stringify(dataForPrint).replace(/</g, "&lt;");

    // ================== เขียน HTML หน้า Label ==================
    win.document.write("<!DOCTYPE html>");
    win.document.write("<html lang='th'>");
    win.document.write("<head>");
    win.document.write("<meta charset='UTF-8' />");
    win.document.write("<meta name='viewport' content='width=device-width, initial-scale=1.0'/>");
    win.document.write("<title>Label 102x30 mm</title>");
    win.document.write("<script src='https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js'><\/script>");
    win.document.write("<script src='https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js'><\/script>");
    win.document.write("<style>");
    win.document.write("@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap');");
    win.document.write("body{font-family:'Noto Sans Thai',sans-serif;margin:0;padding:0;}");
    win.document.write(".container{display:block;width:106mm;}");
    win.document.write(".sticker{width:106mm;height:30mm;display:flex;flex-direction:row;background:white;box-sizing:border-box;margin-bottom:0;}");
    win.document.write(".label{width:53mm;height:30mm;box-sizing:border-box;padding:1mm;display:flex;flex-direction:column;justify-content:space-between;border-right:0.5px solid #ccc;}");
    win.document.write(".label:last-child{border-right:none;}");
    win.document.write(".row{display:flex;flex-direction:row;align-items:center;margin-bottom:1mm;}");
    win.document.write(".qr{width:10mm;height:10mm;margin-right:5mm;margin-left:3mm;}");
    win.document.write(".material{font-size:24px;font-weight:bold;text-align:left;margin:0;line-height:1;}");
    win.document.write(".technician{font-size:10px;text-align:left;margin:0;margin-right:2mm;line-height:1;}");
    win.document.write(".department{font-size:10px;text-align:left;margin:0;margin-right:2mm;line-height:1;}");
    win.document.write(".description{font-size:10px;font-weight:bold;text-align:left;line-height:1.2;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;word-wrap:break-word;margin:0;margin-left:2mm;}");
    win.document.write(".location{font-size:12px;font-weight:bold;text-align:left;margin-top:1px;margin-bottom:0;line-height:1.1;margin-left:2mm;}");
    win.document.write(".lot-line{display:flex;justify-content:space-between;font-size:12px;font-weight:bold;margin-top:0;margin-bottom:0;line-height:1.1;margin-left:2mm;margin-right:1mm;}");
    win.document.write(".lot{font-size:8px;text-align:left;line-height:1;margin:0;}");
    win.document.write(".barcode{margin-left:2mm;width:15mm !important;height:6mm !important;}");
    win.document.write(".print-button{position:fixed;top:10px;right:10px;padding:8px 16px;background-color:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;z-index:1000;}");
    win.document.write(".print-button:hover{background-color:#45a049;}");
    win.document.write(".spinner-container{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:flex;justify-content:center;align-items:center;z-index:2000;}");
    win.document.write(".spinner{border:4px solid #f3f3f3;border-top:4px solid #4CAF50;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;}");
    win.document.write("@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}");
    win.document.write("@media print{.print-button,.spinner-container{display:none;}body{margin:0;padding:0;}.container{width:102mm;margin:0;}.sticker{page-break-inside:avoid;margin:0;}}");
    win.document.write("</style>");
    win.document.write("</head>");
    win.document.write("<body>");
    win.document.write("<button class='print-button' onclick='window.print()'>Print Preview</button>");
    win.document.write("<div class='spinner-container' id='spinner'><div class='spinner'></div></div>");
    win.document.write("<div id='app'><p style='text-align:center;'>กำลังโหลดข้อมูล...</p></div>");

    // ================== JS ภายในหน้าพิมพ์ ==================
    win.document.write("<script>");
    win.document.write("var dataFromParent = " + jsonText + ";");

    win.document.write("function loadAndRender(){");
    win.document.write("  var cleanedData = dataFromParent || [];");  // ใช้ข้อมูลจาก parent");
    // ให้ spinner โชว์อย่างน้อย 3 วินาที เหมือนตัวอย่าง
    win.document.write("  setTimeout(function(){");
    win.document.write("    var sp = document.getElementById('spinner'); if(sp) sp.style.display='none';");
    win.document.write("    renderLabels(cleanedData);");
    win.document.write("  }, 3000);");
    win.document.write("}");

    win.document.write("function renderLabels(data){");
    win.document.write("  var app = document.getElementById('app');");
    win.document.write("  app.innerHTML = '<div class=\"container\"></div>';"); // ใช้ container width:106mm");
    win.document.write("  var container = app.querySelector('.container');");
    win.document.write("  var expandedData = [];");

    // ขยายตามจำนวนชิ้น (จำนวน)
    win.document.write("  data.forEach(function(row){");
    win.document.write("    var qty = Math.max(1, parseInt(row.จำนวน) || 1);");
    win.document.write("    for(var i=0;i<qty;i++){ expandedData.push(row); }");
    win.document.write("  });");

    // วาง 2 label ต่อ 1 sticker
    win.document.write("  for(var i=0;i<expandedData.length;i+=2){");
    win.document.write("    var sticker = document.createElement('div');");
    win.document.write("    sticker.className = 'sticker';");
    win.document.write("    var label1 = createLabel(expandedData[i]);");
    win.document.write("    sticker.appendChild(label1);");
    win.document.write("    if(i+1 < expandedData.length){");
    win.document.write("      var label2 = createLabel(expandedData[i+1]);");
    win.document.write("      sticker.appendChild(label2);");
    win.document.write("    } else {");
    win.document.write("      var emptyLabel = document.createElement('div');");
    win.document.write("      emptyLabel.className = 'label';");
    win.document.write("      emptyLabel.innerHTML = '<div class=\"description\">ไม่มีข้อมูล</div>';");    
    win.document.write("      sticker.appendChild(emptyLabel);");
    win.document.write("    }");
    win.document.write("    container.appendChild(sticker);");
    win.document.write("  }");
    win.document.write("}");

    win.document.write("function createLabel(row){");
    win.document.write("  var label = document.createElement('div');");
    win.document.write("  label.className = 'label';");

    // แถวบน: QR + Material + ชื่อช่าง + แผนก
    win.document.write("  var rowDiv = document.createElement('div');");
    win.document.write("  rowDiv.className = 'row';");

    win.document.write("  var qrCanvas = document.createElement('canvas');");
    win.document.write("  qrCanvas.className = 'qr';");
    win.document.write("  rowDiv.appendChild(qrCanvas);");

    win.document.write("  var textContainer = document.createElement('div');");
    win.document.write("  textContainer.style.display = 'flex';");
    win.document.write("  textContainer.style.flexDirection = 'column';");

    win.document.write("  var materialDiv = document.createElement('div');");
    win.document.write("  materialDiv.className = 'material';");
    win.document.write("  materialDiv.textContent = row.Material || '';");    
    win.document.write("  textContainer.appendChild(materialDiv);");

    win.document.write("  var technicianDiv = document.createElement('div');");
    win.document.write("  technicianDiv.className = 'technician';");
    win.document.write("  var techName = row['ชื่อช่าง'] || '';");    
    win.document.write("  techName = techName.replace(/^นาย\\s+/, '');");    
    win.document.write("  technicianDiv.textContent = techName;");
    win.document.write("  textContainer.appendChild(technicianDiv);");

    win.document.write("  var departmentDiv = document.createElement('div');");
    win.document.write("  departmentDiv.className = 'department';");
    win.document.write("  departmentDiv.textContent = row['แผนก'] || '';");
    win.document.write("  textContainer.appendChild(departmentDiv);");

    win.document.write("  rowDiv.appendChild(textContainer);");
    win.document.write("  label.appendChild(rowDiv);");

    // Description
    win.document.write("  var desc = document.createElement('div');");
    win.document.write("  desc.className = 'description';");
    win.document.write("  desc.textContent = row.Description || '';");
    win.document.write("  label.appendChild(desc);");

    // บรรทัด Loc + Barcode
    win.document.write("  var locLine = document.createElement('div');");
    win.document.write("  locLine.style.display = 'flex';");
    win.document.write("  locLine.style.alignItems = 'center';");
    win.document.write("  locLine.style.fontSize = '12px';");
    win.document.write("  locLine.style.fontWeight = 'bold';");
    win.document.write("  locLine.style.lineHeight = '1.1';");
    win.document.write("  locLine.style.marginLeft = '2mm';");
    win.document.write("  locLine.style.marginTop = '1px';");
    win.document.write("  locLine.style.marginBottom = '0';");

    win.document.write("  var locText = document.createElement('span');");
    win.document.write("  locText.textContent = 'Loc: ' + (row.Storagebin || '');");
    win.document.write("  locLine.appendChild(locText);");

    win.document.write("  var barcodeCanvas = document.createElement('canvas');");
    win.document.write("  barcodeCanvas.className = 'barcode';");
    win.document.write("  locLine.appendChild(barcodeCanvas);");

    win.document.write("  label.appendChild(locLine);");

    // บรรทัด Lot
    win.document.write("  var now = new Date();");
    win.document.write("  var formattedDate = ");
    win.document.write("    now.getFullYear().toString().slice(2) +");
    win.document.write("    ('0' + (now.getMonth() + 1)).slice(-2) +");
    win.document.write("    ('0' + now.getDate()).slice(-2) +");
    win.document.write("    ('0' + now.getHours()).slice(-2) +");
    win.document.write("    ('0' + now.getMinutes()).slice(-2);");

    win.document.write("  var lot = document.createElement('div');");
    win.document.write("  lot.className = 'lot-line';");
    win.document.write("  var lotSpan = document.createElement('span');");
    win.document.write("  lotSpan.textContent = 'Lot: ' + formattedDate + ' (' + (row.จำนวน || 1) + ') ' + (row.Pack || '') + ' ' + (row.Unit || '');");
    win.document.write("  lot.appendChild(lotSpan);");
    win.document.write("  label.appendChild(lot);");

    // สร้าง QR
    win.document.write("  if (typeof QRCode !== 'undefined') {");
    win.document.write("    QRCode.toCanvas(qrCanvas, row.Material || 'N/A', {");
    win.document.write("      width: 40,");
    win.document.write("      height: 40,");
    win.document.write("      margin: 0,");
    win.document.write("      errorCorrectionLevel: 'L'");
    win.document.write("    }, function(err){ if(err) console.error('QR Error:', err); });");
    win.document.write("  }");

    // สร้าง Barcode
    win.document.write("  if (typeof JsBarcode !== 'undefined' && row.Material) {");
    win.document.write("    JsBarcode(barcodeCanvas, row.Material, {");
    win.document.write("      format: 'CODE128',");
    win.document.write("      width: 1,");
    win.document.write("      height: 15,");
    win.document.write("      displayValue: false,");
    win.document.write("      margin: 0");
    win.document.write("    }, function(err){ if(err) console.error('Barcode Error:', err); });");
    win.document.write("  }");

    win.document.write("  return label;");
    win.document.write("}");

    win.document.write("loadAndRender();");
    win.document.write("<\/script>");

    win.document.write("</body></html>");
    win.document.close();
}


/* =================== เดิม =================== */

async function loadUsers(){
    try{
        const res=await fetch(userUrl);
        users=await res.json();
    }catch(e){
        console.error(e);
        alert("ไม่สามารถโหลดข้อมูลผู้ใช้ได้");
    }
}

/* ★ โหลดข้อมูล Employee */
async function loadEmployees(){
    try{
        const res = await fetch(employeeUrl);
        employees = await res.json();
        // console.log('employees', employees);
    }catch(e){
        console.error(e);
        // ถ้าโหลดไม่ได้ ไม่ต้อง alert เพื่อไม่ให้รบกวนการใช้งานหลัก
    }
}

function checkLogin(){
    const remembered=localStorage.getItem('rememberedUser');
    if(remembered){
        loggedUser=JSON.parse(remembered);
        showUserMenu();
        document.getElementById('plantSelection').style.display='block';
        return true;
    }
    const sessionUser=sessionStorage.getItem('loggedUser');
    if(sessionUser){
        loggedUser=JSON.parse(sessionUser);
        showUserMenu();
        document.getElementById('plantSelection').style.display='block';
        return true;
    }
    return false;
}
function showLogin(){document.getElementById('loginModal').style.display='flex';}
function hideLogin(){document.getElementById('loginModal').style.display='none';}
function login(){
    const idUser=document.getElementById('idUserInput').value.trim();
    const password=document.getElementById('passwordInput').value.trim();
    const remember=document.getElementById('rememberMe').checked;
    const user=users.find(u=>u.IDUser===idUser);
    if(user&&password===idUser.slice(-4)){
        loggedUser={IDUser:user.IDUser,Name:user.Name||'ไม่ระบุ'};
        if(remember)localStorage.setItem('rememberedUser',JSON.stringify(loggedUser));
        else sessionStorage.setItem('loggedUser',JSON.stringify(loggedUser));
        hideLogin();showUserMenu();
        document.getElementById('plantSelection').style.display='block';
    }else{
        document.getElementById('loginError').textContent='IDUser หรือ Password ไม่ถูกต้อง';
    }
}
function logout(){
    localStorage.removeItem('rememberedUser');
    sessionStorage.removeItem('loggedUser');
    loggedUser=null;
    cartItems = [];       // ★ เคลียร์ตะกร้าเมื่อ logout
    updateCartCount();
    document.getElementById('userMenu').style.display='none';
    document.getElementById('menuBtn').style.display='none';
    document.getElementById("mainCardsSection").style.display="none";
    document.getElementById("summarySection").style.display="none";
    document.getElementById("controlsSection").style.display="none";
    document.getElementById("tableSection").style.display="none";
    document.getElementById("pagination").style.display="none";
    document.getElementById('plantSelection').style.display="none";
    document.getElementById('backBtn').style.display="none";
    showLogin();
}

function showUserMenu(){
    document.getElementById('menuBtn').style.display='block';
    document.getElementById('userID').textContent=`รหัส: ${loggedUser.IDUser}`;
    document.getElementById('userName').textContent=`ชื่อ: ${loggedUser.Name}`;
}
document.getElementById('menuBtn').addEventListener('click',()=>{
    const menu=document.getElementById('userMenu');
    menu.style.display=menu.style.display==='block'?'none':'block';
});
document.getElementById('logoutBtn').addEventListener('click',logout);
document.getElementById('loginBtn').addEventListener('click',login);

// =========================
// ✅ HELP MODAL CONTROL
// =========================
function openHelp(){
  const m = document.getElementById('helpModal');
  if(m) m.style.display = 'flex';

  // ปิดเมนู userMenu ด้วย (กันซ้อน)
  const menu = document.getElementById('userMenu');
  if(menu) menu.style.display = 'none';
}
function closeHelp(){
  const m = document.getElementById('helpModal');
  if(m) m.style.display = 'none';
}

const helpBtn = document.getElementById('helpBtn');
if (helpBtn) helpBtn.addEventListener('click', openHelp);

const helpCloseBtn = document.getElementById('helpCloseBtn');
if (helpCloseBtn) helpCloseBtn.addEventListener('click', closeHelp);

// คลิกพื้นที่ดำเพื่อปิด
const helpModal = document.getElementById('helpModal');
if (helpModal) {
  helpModal.addEventListener('click', (e) => {
    if (e.target === helpModal) closeHelp();
  });
}

// กด ESC เพื่อปิด
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeHelp();
});

async function init(){
    await loadUsers();
    await loadEmployees();   // ★ โหลดพนักงานเพิ่ม
    if(!checkLogin())showLogin();
    const plantSelect=document.getElementById('plantSelect');
    Object.keys(inventoryUrls).sort().forEach(p=>{
        const name=plantNames[p]||p;
        plantSelect.add(new Option(`${p} - ${name}`,p));
    });

    /* ★ ผูก event ตะกร้ารวม */
       document.getElementById('cartMainBtn').addEventListener('click', openCartModal);
    document.getElementById('cartCloseBtn').addEventListener('click', closeCartModal);
    document.getElementById('cartPrintBtn').addEventListener('click', printCart);
    document.getElementById('cartClearBtn').addEventListener('click', clearCart); // ★

      const empCodeInput = document.getElementById('employeeCode');
    if(empCodeInput){
        empCodeInput.addEventListener('input', updateEmployeeInfo);
        empCodeInput.addEventListener('blur', updateEmployeeInfo);
    }
}
init();

document.getElementById('viewBtn').addEventListener('click',()=>{
    selectedPlant=document.getElementById('plantSelect').value;
    if(!selectedPlant){alert('กรุณาเลือก Plant');return;}
    inventoryUrl=inventoryUrls[selectedPlant];
    if(!inventoryUrl){alert('ไม่มีข้อมูลสำหรับ Plant นี้');return;}
    document.getElementById('plantSelection').style.display='none';
    document.getElementById('backBtn').style.display='block';
    loadData();
});
document.getElementById('backBtn').addEventListener('click',()=>{
    document.getElementById('mainCardsSection').style.display='none';
    document.getElementById('summarySection').style.display='none';
    document.getElementById('controlsSection').style.display='none';
    document.getElementById('tableSection').style.display='none';
    document.getElementById('pagination').style.display='none';
    document.getElementById('backBtn').style.display='none';
    document.getElementById('plantSelection').style.display='block';
    allData=[];filteredData=[];mode="all";abcFilter="";movingFilter="";currentPage=1;
    document.getElementById("searchInput").value="";
    document.getElementById("statusFilter").value="";
    document.getElementById("responsibleFilter").value="";
    document.getElementById("plantFilter").disabled=false;
});

async function loadData(){
    const loader=document.getElementById("loader");
    const summarySection=document.getElementById("summarySection");
    const controlsSection=document.getElementById("controlsSection");
    const tableSection=document.getElementById("tableSection");
    loader.style.display="block";
    summarySection.style.display="none";
    controlsSection.style.display="none";
    tableSection.style.display="none";
    try{
        const [
            invRes,usageRes,mainsapRes,avgValRes,statusRes,
            locationRes,shelfRes
        ]=await Promise.all([
            fetch(inventoryUrl),
            fetch(usageUrl),
            fetch(mainsapUrl),
            fetch(avgValUrl),
            fetch(statusUrl),
            fetch(locationUrl),
            fetch(shelfUrl)
        ]);
        const inv=await invRes.json();
        const usage=await usageRes.json();
        const mainsap=await mainsapRes.json();
        const avgValData=await avgValRes.json();
        const statusData=await statusRes.json();
        const locationData=await locationRes.json();
        const shelfData=await shelfRes.json();

        const navanakornMap = new Map();
        locationData.forEach(r => {
            const mat = (r.Material || '').toString().trim();
            const navQty = toNumber(r.Unrestricted || r["Unrestricted"] || 0);
            if (mat) {
                navanakornMap.set(mat, navQty);
            }
        });

        const statusMap=new Map();
        statusData.forEach(r=>{
            const plant=(r.Plant||'').toString().trim();
            const material=(r.Material||'').toString().trim();
            let status='';
            const keys=Object.keys(r);
            const statusKeys=keys.filter(k=>
                k.toLowerCase().includes('statusmaterial')||
                k.toLowerCase().includes('status material')||
                k.toLowerCase().includes('สถานะวัสดุ')
            );
            if(statusKeys.length>0) status=(r[statusKeys[0]]||'').toString().trim();
            else{
                const alt=keys.filter(k=>k.toLowerCase().includes('status'));
                if(alt.length>0)status=(r[alt[0]]||'').toString().trim();
            }
            if(plant&&material){
                const key=`${plant}-${material}`;
                if(status)statusMap.set(key,status);
            }
        });

        const avgValMap=new Map();
        avgValData.forEach(r=>{
            const material=(r.Material||'').toString().trim();
            const avgVal=toNumber(r.AvgVal||r.AvgVAL||r.avgval||0);
            if(material)avgValMap.set(material,avgVal);
        });

        const usageMap=new Map();
        usage.forEach(r=>{
            const plant=(r.Plant||'').toString().trim();
            const material=(r.Material||'').toString().trim();
            if(!plant||!material)return;
            const key=`${plant}-${material}`;
            let qty4m=0,qty6m=0,thirtyDay=0;
            const keys=Object.keys(r);
            const k4=keys.filter(k=>k.toLowerCase().includes('4m')||k.toLowerCase().includes('4 month')||k.toLowerCase().includes('qtyissu'));
            if(k4.length>0)qty4m=toNumber(r[k4[0]]||0);
            const k6=keys.filter(k=>k.toLowerCase().includes('6m')||k.toLowerCase().includes('6 month'));
            if(k6.length>0)qty6m=toNumber(r[k6[0]]||0);
            const k30=keys.filter(k=>k.toLowerCase().includes('30day')||k.toLowerCase().includes('30 day')||k.toLowerCase().includes('30'));
            if(k30.length>0)thirtyDay=toNumber(r[k30[0]]||0);
            usageMap.set(key,{
                Qty4Month:qty4m,
                Qty6Month:qty6m||Math.round(qty4m*1.5),
                ThirtyDay:thirtyDay
            });
        });

        const mainsapMap=new Map();
        mainsap.forEach(r=>{
            const mat=(r.Material||'').toString().trim();
            if(!mat)return;
            mainsapMap.set(mat,{
                Note:r['หมายเหตุ']||'',
                MultiplyUnit:r['คูณหน่วย']?toNumber(r['คูณหน่วย']):1,
                Product:r.Product||''
            });
        });

        locationMap=new Map();
        locationData.forEach(r=>{
            const material=(r.Material||'').toString().trim();
            if(!material)return;
            const keys=Object.keys(r);
            const storageKey=
                keys.find(k=>k.toLowerCase().includes('storage')&&k.toLowerCase().includes('bin'))||
                keys.find(k=>k.toLowerCase().includes('storagebin'))||
                keys.find(k=>k.toLowerCase().includes('bin'));
            if(!storageKey)return;
            const loc=(r[storageKey]||'').toString().trim();
            if(loc)locationMap.set(material,loc);
        });

        shelfOwnerMap=new Map();
        shelfData.forEach(r=>{
            const shelf=(r.Shelf||'').toString().trim();
            const userId=(r.UserID||r.UserId||r.userid||'').toString().trim();
            if(shelf&&userId)shelfOwnerMap.set(shelf,userId);
        });

        allData=[];
        inv.forEach(r=>{
            const plant=(r.Plant||'').toString().trim();
            const material=(r.Material||'').toString().trim();
            if(plant!==selectedPlant||!material)return;
            const key=`${plant}-${material}`;
            const usageInfo=usageMap.get(key)||{Qty4Month:0,Qty6Month:0,ThirtyDay:0};
            const main=mainsapMap.get(material)||{Note:'',MultiplyUnit:1,Product:''};
            const status=statusMap.get(key)||'';
            const avgVal=avgValMap.get(material)||0;
            const qty4m=usageInfo.Qty4Month;
            const qty6m=usageInfo.Qty6Month;
            const thirtyDay=usageInfo.ThirtyDay;
            const unrestricted=toNumber(r.Unrestricted||r["Unrestricted stock"]||0);
            const originalValue=toNumber(r["Value Unrestricted"]||r["Value unrestricted"]||0);
            const description=r["Material description"]||'';
            const keys=Object.keys(r);
            let storageBin='';
            const sk=
                keys.find(k=>k.toLowerCase().includes('storage')&&k.toLowerCase().includes('bin'))||
                keys.find(k=>k.toLowerCase().includes('storagebin'))||
                keys.find(k=>k.toLowerCase().includes('bin'));
            if(sk)storageBin=(r[sk]||'').toString().trim();
            let unit=r["Base Unit of Measure"]||'';
            if(!unit){
                const uk=keys.find(k=>k.toLowerCase().includes('unit')||k.toLowerCase().includes('uom'));
                if(uk)unit=(r[uk]||'').toString().trim();
            }
            const navanakornQty = navanakornMap.get(material) || 0;
            let value=avgVal>0?unrestricted*avgVal:originalValue;

            const location=locationMap.get(material)||storageBin||'';
            const shelf=location?location.substring(0,3):'';
            const ownerId=shelfOwnerMap.get(shelf)||'';
            const ownerName=getOwnerName(ownerId);

           allData.push({
    Plant:plant,
    Material:material,
    Description:description,
    StorageBin:storageBin,
    Unit:unit,
    Navanakorn: navanakornQty,
    Unrestricted:unrestricted,
    Value:value,
    Qty6Month:qty6m,
    Qty4Month:qty4m,
    ThirtyDay:thirtyDay,
    AvgDailyUse:qty4m/120||0,
    AvgMonthly:qty4m/4,
    SafetyStock:0,ROP:0,DOS:0,RecommendedOrder:0,Mean:0,
    ABCValue:"",CumPercent:0,Moving:"",
    ReturnQty:0,ReturnValue:0,
    Note:main.Note,
    MultiplyUnit:main.MultiplyUnit,
    Product:main.Product,
    AvgVal:avgVal,
    OriginalValue:originalValue,
    Status:status,
    Location:location,
    Shelf:shelf,
    OwnerId:ownerId,
    OwnerName:ownerName,
    ActualOrder: null,          // ✅ ให้เป็น null แทน 0
    _actualOrderTouched: false  // ยังไม่เคยแก้
});


        });
// หลังจากเติม allData เสร็จ
loadActualOrdersFromLocalStorage();
calcABCValue();
        const plantFilter=document.getElementById("plantFilter");
        plantFilter.innerHTML='';
        const name=plantNames[selectedPlant]||selectedPlant;
        plantFilter.add(new Option(`${selectedPlant} - ${name}`,selectedPlant));
        plantFilter.disabled=true;

        const updateBtn = document.getElementById("updateBtn");
        if (sheetIds[selectedPlant]) {
            updateBtn.style.display = "inline-flex";
            updateBtn.onclick = () => {
                const sheetId = sheetIds[selectedPlant];
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/edit`;
                window.open(url, '_blank');
            };
        } else {
            updateBtn.style.display = "none";
        }

        const lastLabel = document.getElementById("lastUpdateLabel");
        lastLabel.textContent = "";
        const apiUrl = lastUpdateApiByPlant[selectedPlant];
        if (apiUrl) {
            lastLabel.textContent = "กำลังตรวจสอบเวลาอัปเดต...";
            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    if (data.modifiedTime) {
                        const dt = new Date(data.modifiedTime);
                        const thTime = dt.toLocaleString('th-TH', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        lastLabel.textContent = `อัปเดตล่าสุด: ${thTime}`;
                    } else {
                        lastLabel.textContent = "";
                    }
                })
                .catch(err => {
                    console.error('Error fetch modifiedTime', err);
                    lastLabel.textContent = "";
                });
        } else {
            lastLabel.textContent = "";
        }

        loader.style.display="none";
        document.getElementById("mainCardsSection").style.display="flex";
        document.getElementById("summarySection").style.display="flex";
        document.getElementById("controlsSection").style.display="flex";
        document.getElementById("tableSection").style.display="block";
        document.getElementById("pagination").style.display="block";

        setDefaultAndCalculate();
    }catch(e){
        loader.style.display="none";
        alert("โหลดข้อมูลไม่สำเร็จ กรุณารีเฟรช");
        console.error(e);
    }
}

function calcABCValue(){
    const sorted=[...allData].sort((a,b)=>b.Value-a.Value);
    const total=sorted.reduce((s,r)=>s+r.Value,0);
    let cum=0;
    sorted.forEach(r=>{
        cum+=r.Value;
        const pct=total?(cum/total)*100:0;
        const orig=allData.find(x=>x.Material===r.Material&&x.Plant===r.Plant);
        if(orig){
            orig.CumPercent=pct;
            orig.ABCValue=pct<=70?"A":pct<=90?"B":"C";
        }
    });
}

function recalculateStockFields(data, params){
  data.forEach(r => {

    // =========================
    // 1) ค่าพื้นฐาน + แปลงเป็นตัวเลข
    // =========================
    const leadTime   = Number(params?.leadTime ?? 5);
    const safetyDays = Number(params?.safety   ?? 3);
    const coverDays  = Number(params?.cover    ?? 40);

    const qty4m  = Number(r.Qty4Month  || 0);
    const qty6m  = Number(r.Qty6Month  || 0); // เผื่ออยากใช้ต่อ
    const qty30d = Number(r.ThirtyDay  || 0);

    const unrestricted = Number(r.Unrestricted || 0);
    const mul = Number(r.MultiplyUnit || 1);

    // avg ต่อวันจากแต่ละช่วงเวลา
    const avg4mDaily  = qty4m  / 120;  // 4 เดือน = 120 วัน
    const avg30dDaily = qty30d / 30;   // 30 วัน = 30 วัน

    // avg ต่อเดือนจาก 4 เดือน (ใช้จัด Moving)
    const avgMonthlyFrom4m = qty4m / 4;

    // =========================
    // 2) Moving Classification (ของเดิม แต่ชัดเจน)
    // =========================
    if (avgMonthlyFrom4m === 0)            r.Moving = "Dead";
    else if (avgMonthlyFrom4m < 0.7)       r.Moving = "Slowly";
    else if (avgMonthlyFrom4m < 12)        r.Moving = "Slow";
    else if (avgMonthlyFrom4m < 30)        r.Moving = "Medium";
    else                                   r.Moving = "Fast";

    // เก็บไว้ให้ตารางใช้เหมือนเดิม
    r.AvgMonthly = avgMonthlyFrom4m;

    // =========================
    // 3) Weighted Weight (ฉลาดขึ้น)
    // - Fast ฟัง 30Day มากขึ้น
    // - Slow/Dead ฟัง 4M มากขึ้น
    // - ABC A ไวขึ้น, C ช้าลง
    // =========================
    let w4m = 0.70, w30 = 0.30;

    if (r.Moving === "Fast")   { w4m = 0.50; w30 = 0.50; }
    if (r.Moving === "Medium") { w4m = 0.60; w30 = 0.40; }
    if (r.Moving === "Slow")   { w4m = 0.80; w30 = 0.20; }
    if (r.Moving === "Slowly" || r.Moving === "Dead") { w4m = 0.90; w30 = 0.10; }

    // ปรับตาม ABC
    if (r.ABCValue === "A") { w4m -= 0.05; w30 += 0.05; }
    if (r.ABCValue === "C") { w4m += 0.05; w30 -= 0.05; }

    // clamp + normalize
    w4m = Math.max(0.05, Math.min(0.95, w4m));
    w30 = 1 - w4m;

    // =========================
    // 4) Outlier Guard (กัน 30Day พุ่ง)
    // ถ้า 30Day ต่อวัน > 4M ต่อวัน * limitMultiplier
    // ให้จำกัดไว้
    // =========================
    const limitMultiplier = 3; // ปรับได้ 2-4 ตามใจ
    let guarded30dDaily = avg30dDaily;

    if (avg4mDaily > 0 && avg30dDaily > avg4mDaily * limitMultiplier) {
      guarded30dDaily = avg4mDaily * limitMultiplier;
    }

    // =========================
    // 5) Seasonal Mode (เอาหมด)
    // แนวคิด: ถ้า 30Day "สูงกว่า" 4M มาก (แปลว่าช่วงนี้กำลังพีค)
    // ให้เพิ่มน้ำหนัก 30Day แบบชั่วคราว แต่ไม่ให้เกินเพดาน
    // =========================
    const seasonalTrigger = 1.8; // ถ้า 30Day > 4M * 1.8 ถือว่าพีค
    const seasonalBoostMax = 0.20; // เพิ่มน้ำหนัก 30Day สูงสุด +0.20

    if (avg4mDaily > 0) {
      const ratio = avg30dDaily / avg4mDaily;
      if (ratio >= seasonalTrigger) {
        // เพิ่ม w30 ตามระดับความพีค แต่ไม่เกิน seasonalBoostMax
        const boost = Math.min(seasonalBoostMax, (ratio - seasonalTrigger) * 0.10);
        w30 = Math.min(0.95, w30 + boost);
        w4m = 1 - w30;
      }
    }

    // =========================
    // 6) AvgDailyUse (ตัวหลักในการคำนวณสต๊อก)
    // =========================
    let avgDailyUse = (avg4mDaily * w4m) + (guarded30dDaily * w30);
    if (!isFinite(avgDailyUse) || avgDailyUse < 0) avgDailyUse = 0;
    r.AvgDailyUse = avgDailyUse;

    // =========================
    // 7) Mean (ฉลาดขึ้น)
    // เดิม: max(ThirtyDay, AvgMonthly)
    // ใหม่: Mean รายเดือน = (AvgMonthly 4M * w4m) + (30Day(ถือเป็น1เดือน) * w30)
    // =========================
    const avgMonthlyFrom30d = qty30d; // 30 วัน = 1 เดือน
    let meanMonthly = (avgMonthlyFrom4m * w4m) + (avgMonthlyFrom30d * w30);

    // guard Mean เหมือนกัน
    if (avgMonthlyFrom4m > 0 && avgMonthlyFrom30d > avgMonthlyFrom4m * limitMultiplier) {
      meanMonthly = (avgMonthlyFrom4m * w4m) + ((avgMonthlyFrom4m * limitMultiplier) * w30);
    }

    if (!isFinite(meanMonthly) || meanMonthly < 0) meanMonthly = 0;
    r.Mean = meanMonthly;

    // =========================
    // 8) Stockout Protection (เอาหมด)
    // ถ้า Fast/Medium แต่ของหมด → เพิ่ม SafetyDays ชั่วคราว
    // (เพื่อกันขาดช่วง lead time)
    // =========================
    let safetyDaysEffective = safetyDays;

    if (unrestricted === 0 && (r.Moving === "Fast" || r.Moving === "Medium")) {
      // เพิ่ม safety อีก 30% ของ coverDays (แต่ไม่ต่ำกว่า +3 วัน)
      const add = Math.max(3, Math.round(coverDays * 0.30));
      safetyDaysEffective = safetyDays + add;

      // ถ้าเป็น ABC A เพิ่มอีกนิด
      if (r.ABCValue === "A") safetyDaysEffective += 2;
    }

    // กัน safetyDaysEffective บาน
    safetyDaysEffective = Math.min(365, Math.max(0, safetyDaysEffective));

    // =========================
    // 9) SafetyStock / ROP / DOS
    // ใช้ AvgDailyUse ใหม่ + safetyDaysEffective
    // =========================
    const d = r.AvgDailyUse || 0;

    const safetyStock = d * safetyDaysEffective;
    const rop = (d * leadTime) + safetyStock;

    const dos = d > 0 ? (unrestricted / d) : 9999;

    r.SafetyStock = Math.round(safetyStock);
    r.ROP         = Math.round(rop);
    r.DOS         = dos > 9999 ? 9999 : Number(dos.toFixed(1));

    // =========================
    // 10) RecommendedOrder
    // ถ้าคงเหลือ < ROP → เติมให้ครอบคลุม coverDays
    // =========================
    let recommend = 0;

    if (unrestricted < rop) {
      const needed = d * coverDays;           // ต้องมีให้ครอบคลุม coverDays
      recommend = needed - unrestricted;      // ขาดเท่าไรเติมเท่านั้น
      if (recommend < 0) recommend = 0;
    }

    // ปัดตามแพ็ค
    if (mul > 0) recommend = Math.ceil(recommend / mul) * mul;
    r.RecommendedOrder = Math.round(recommend);

    // =========================
    // 11) สั่งจริง (ไม่ทับถ้า user เคยแก้)
    // =========================
    if (!r._actualOrderTouched) {
      if (r.ActualOrder == null || isNaN(r.ActualOrder)) {
        r.ActualOrder = r.RecommendedOrder;
      }
    }

    // =========================
    // 12) กฎตัดสั่งเดิมของคุณ (คงไว้ แต่ใช้ Mean ใหม่ที่นิ่งกว่า)
    // =========================
    if (r.Mean === 0 && (r.Moving === "Slow" || r.Moving === "Slowly")) r.RecommendedOrder = 0;
    if (qty30d === 0 && (r.Moving === "Slow" || r.Moving === "Slowly")) r.RecommendedOrder = 0;
    if (qty30d >= qty4m && r.Moving === "Slowly") r.RecommendedOrder = 0;

    // =========================
    // 13) ReturnQty / ReturnValue (เดิม)
    // =========================
    const keepQty = calculateKeepQty(r);
    const returnQty = Math.max(0, unrestricted - keepQty);
    const unitPrice = unrestricted > 0 ? (Number(r.Value || 0) / unrestricted) : 0;

    r.ReturnQty   = Math.round(returnQty);
    r.ReturnValue = returnQty * unitPrice;

  });
}

function populateOwnerFilter(dataList){
    const sel=document.getElementById("responsibleFilter");
    const current=sel.value;
    sel.innerHTML='<option value="">ทุกคน</option>';
    const owners=new Map();
    let hasEmpty=false;
    (dataList||allData).forEach(r=>{
        if(r.OwnerId){
            if(!owners.has(r.OwnerId))owners.set(r.OwnerId,r.OwnerName||r.OwnerId);
        }else{
            hasEmpty=true;
        }
    });
    if(hasEmpty){
        const optEmpty=document.createElement("option");
        optEmpty.value="__EMPTY__";
        optEmpty.textContent="(ค่าว่าง)";
        sel.appendChild(optEmpty);
    }
    Array.from(owners.entries())
        .sort((a,b)=>a[1].localeCompare(b[1],'th-TH'))
        .forEach(([id,name])=>{
            const opt=document.createElement("option");
            opt.value=id;
            opt.textContent=`${name} (${id})`;
            sel.appendChild(opt);
        });
    if(current && Array.from(sel.options).some(o=>o.value===current)){
        sel.value=current;
    }else{
        sel.value="";
    }
}

function populateStatusFilter(){
    const statusFilter=document.getElementById("statusFilter");
    const current=statusFilter.value;
    statusFilter.innerHTML='<option value="">ทุกสถานะ</option><option value="ไม่มีสถานะ">ไม่มีสถานะ</option>';
    const statusSet=new Set();
    allData.forEach(r=>{
        if(r.Status&&r.Status.trim()!=="")statusSet.add(r.Status.trim());
    });
    Array.from(statusSet).sort().forEach(s=>{
        const opt=document.createElement("option");
        opt.value=s;opt.textContent=s;
        statusFilter.appendChild(opt);
    });
    if(current && Array.from(statusFilter.options).some(o=>o.value===current)){
        statusFilter.value=current;
    }else{
        statusFilter.value="";
    }
}

function setDefaultAndCalculate(){
    document.getElementById("statusFilter").value="";
    document.getElementById("searchInput").value="";
    document.getElementById("responsibleFilter").value="";
    mode="all";abcFilter="";movingFilter="";
    populateStatusFilter();
    applyFiltersAndRender();
}

document.getElementById("tableHeader").addEventListener("click",e=>{
    const col=e.target.closest("th[data-sort]");
    if(!col)return;
    const key=col.getAttribute("data-sort");
    if(sortKey===key)sortDir=sortDir==="asc"?"desc":"asc";
    else{sortKey=key;sortDir="desc";}
    applyFiltersAndRender();
});

function applyFiltersAndRender(){
    let data = [...allData];
    data = data.filter(r => !(r.Qty6Month === 0 && r.Unrestricted === 0));
    const search = document.getElementById("searchInput").value.toLowerCase();
    if (search) {
        data = data.filter(r =>
            r.Material.toLowerCase().includes(search) ||
            r.Description.toLowerCase().includes(search)
        );
    }

    const statusVal = document.getElementById("statusFilter").value;
    if (statusVal) {
        if (statusVal === "ไม่มีสถานะ") {
            data = data.filter(r => !r.Status || r.Status.trim() === "");
        } else {
            data = data.filter(r => r.Status === statusVal);
        }
    }

    const params = {
        leadTime: parseInt(document.getElementById("leadTimeDays").value) || 5,
        safety:   parseInt(document.getElementById("safetyDays").value) || 3,
        cover:    parseInt(document.getElementById("coverDays").value) || 40
    };
    recalculateStockFields(data, params);

    let baseData = [...data];
    let viewData = [...data];

    if (mode === "onlyOrder") {
        viewData = viewData.filter(r => Math.round(r.RecommendedOrder) >= 1);
    } else if (mode === "returnable") {
        viewData = viewData.filter(r => r.ReturnQty > 0);
    } else if (mode === "afterReturn") {
        viewData = viewData.map(r => ({
            ...r,
            Unrestricted: r.Unrestricted - r.ReturnQty,
            Value: r.Value - r.ReturnValue
        }));
    }

    populateOwnerFilter(viewData);

    const ownerVal = document.getElementById("responsibleFilter").value;
    if (ownerVal) {
        if (ownerVal === "__EMPTY__") {
            viewData = viewData.filter(r => !r.OwnerId);
            baseData = baseData.filter(r => !r.OwnerId);
        } else {
            viewData = viewData.filter(r => r.OwnerId === ownerVal);
            baseData = baseData.filter(r => r.OwnerId === ownerVal);
        }
    }
   const diffVal = document.getElementById("orderDiffFilter").value;

if (diffVal) {

  const matchDiff = (r) => {
    const nav = Number(r.Navanakorn || 0);
    const rec = Math.round(r.RecommendedOrder || 0);
    const act = Math.round((r.ActualOrder ?? 0));

    if (diffVal === "nav0")   return nav === 0;
    if (diffVal === "navgt0") return nav > 0;

    if (diffVal === "less")  return act < rec;
    if (diffVal === "more")  return act > rec;
    if (diffVal === "equal") return act === rec;

    if (diffVal === "actualgt0") return act > 0;

    return true;
  };

  viewData = viewData.filter(matchDiff);
  baseData = baseData.filter(matchDiff);
}



    if (mode === "onlyOrder") {
        calcABCForMode(viewData, "order");
    } else if (mode === "returnable") {
        calcABCForMode(viewData, "return");
    } else {
        calcABCForMode(viewData, "normal");
    }

    if (abcFilter) {
        viewData = viewData.filter(r => r.ABCValue === abcFilter);
    }
    if (movingFilter) {
        viewData = viewData.filter(r => r.Moving === movingFilter);
    }


    filteredData = [...viewData];
    filteredData.sort((a, b) => {
        let x = a[sortKey] || 0;
        let y = b[sortKey] || 0;
        if (typeof x === "string") x = x.toLowerCase();
        if (typeof y === "string") y = y.toLowerCase();
        return sortDir === "asc" ? (x > y ? 1 : -1) : (x < y ? 1 : -1);
    });

    currentPage = 1;
    renderTable();
    renderPagination();
    updateAllCards(baseData, filteredData);
}

function calcABCForMode(data, modeType){
    let sorted = [...data];

    // ✅ เลือกตัวเลขที่จะใช้จัดอันดับ + รวมมูลค่า
    const getVal = (r) => {
        if (modeType === "order") {
            return (r.RecommendedOrder || 0) * (r.Unrestricted > 0 ? (r.Value / r.Unrestricted) : 0);
        }
        if (modeType === "return") {
            return (r.ReturnValue || 0);
        }
        // ✅ normal = ใช้ Value จริง
        return (r.Value || 0);
    };

    // ✅ sort ตามค่าที่ใช้จริง
    sorted.sort((a,b) => getVal(b) - getVal(a));

    const total = sorted.reduce((s,r) => s + getVal(r), 0);
    let cum = 0;

    sorted.forEach(r => {
        const val = getVal(r);
        cum += val;
        const pct = total ? (cum/total)*100 : 0;

        // เขียนกลับไปยัง object ตัวจริงใน data
        const orig = data.find(x => x.Material === r.Material && x.Plant === r.Plant);
        if (orig) {
            orig.CumPercent = pct;
            orig.ABCValue   = pct <= 70 ? "A" : pct <= 90 ? "B" : "C";
        }
    });
}


function updateAllCards(baseData, filteredData) {
    const abc = { A:0, B:0, C:0 }, cntABC = { A:0, B:0, C:0 };
    const mov = { Fast:0, Medium:0, Slow:0, Slowly:0, Dead:0 },
          cntMov = { Fast:0, Medium:0, Slow:0, Slowly:0, Dead:0 };

    // ✅ ไม่กรอง Qty6Month อีกแล้ว ใช้ filteredData ตรง ๆ ตามโหมด/ตัวกรองที่เลือก
    filteredData.forEach(r => {

        let valueToUse = 0;
        if (mode === "onlyOrder") {
            valueToUse = r.RecommendedOrder * (r.Unrestricted > 0 ? r.Value / r.Unrestricted : 0);
        } else if (mode === "returnable") {
            valueToUse = r.ReturnValue;
        } else {
            valueToUse = r.Value;
        }

        if (r.ABCValue && abc.hasOwnProperty(r.ABCValue)) {
            abc[r.ABCValue] += valueToUse;
            cntABC[r.ABCValue]++;
        }

        if (r.Moving && mov.hasOwnProperty(r.Moving)) {
            mov[r.Moving] += valueToUse;
            cntMov[r.Moving]++;
        }
    });

    // ✅ การ์ด ABC
    document.getElementById("sumA").textContent   = formatShortCurrency(abc.A);
    document.getElementById("sumB").textContent   = formatShortCurrency(abc.B);
    document.getElementById("sumC").textContent   = formatShortCurrency(abc.C);
    document.getElementById("countA").textContent = cntABC.A + " รายการ";
    document.getElementById("countB").textContent = cntABC.B + " รายการ";
    document.getElementById("countC").textContent = cntABC.C + " รายการ";

    // ✅ การ์ด Moving
    document.getElementById("valFast").textContent   = formatShortCurrency(mov.Fast);
    document.getElementById("valMedium").textContent = formatShortCurrency(mov.Medium);
    document.getElementById("valSlow").textContent   = formatShortCurrency(mov.Slow);
    document.getElementById("valSlowly").textContent = formatShortCurrency(mov.Slowly);
    document.getElementById("valDead").textContent   = formatShortCurrency(mov.Dead);
    document.getElementById("countFast").textContent   = cntMov.Fast   + " รายการ";
    document.getElementById("countMedium").textContent = cntMov.Medium + " รายการ";
    document.getElementById("countSlow").textContent   = cntMov.Slow   + " รายการ";
    document.getElementById("countSlowly").textContent = cntMov.Slowly + " รายการ";
    document.getElementById("countDead").textContent   = cntMov.Dead   + " รายการ";

    // ✅ ข้อมูลสำหรับการ์ดมุมบน (มูลค่ารวม / Order / OverStock)
    let dataForMainCards;
    if (mode === "onlyOrder") {
        dataForMainCards = baseData.filter(r => Math.round(r.RecommendedOrder) >= 1);
    } else if (mode === "returnable") {
        dataForMainCards = baseData.filter(r => r.ReturnQty > 0);
    } else {
        // เดิมใช้ baseData.filter(r => r.Qty6Month > 0)
        // ตอนนี้ “เอาทั้งหมด” → ใช้ baseData ตรง ๆ
        dataForMainCards = baseData;
    }

    let totalStock = 0,
        orderItems = 0,
        orderValue = 0,
        returnCount = 0,
        totalReturnValue = 0,
        filteredForTotalCount = 0;

    dataForMainCards.forEach(r => {
        filteredForTotalCount++;

        if (mode === "onlyOrder") {
            totalStock += r.RecommendedOrder * (r.Unrestricted > 0 ? r.Value / r.Unrestricted : 0);
        } else if (mode === "returnable") {
            totalStock += r.ReturnValue;
        } else {
            totalStock += r.Value;
        }

        const qty = Math.round(r.RecommendedOrder);
        if (qty > 0) {
            orderItems++;
            orderValue += qty * (r.Unrestricted > 0 ? r.Value / r.Unrestricted : 0);
        }

        if (r.ReturnQty > 0) returnCount++;
        totalReturnValue += r.ReturnValue;
    });

    document.getElementById("totalStockValue").textContent = formatShortCurrency(totalStock);
    document.getElementById("orderTotalValue").textContent = formatShortCurrency(orderValue);
    document.getElementById("totalCount").textContent      = filteredForTotalCount + " รายการ";
    document.getElementById("orderItemCount").textContent  = orderItems;
    document.getElementById("returnItemCount").textContent = returnCount + " รายการ";
    document.getElementById("returnValue").textContent     = formatShortCurrency(totalReturnValue);

    // ✅ ส่วนคำนวณ เบิก/เดือน, Stock Days, After Stock Days → เอาทั้งหมดเหมือนกัน
    let total_usage_4m_base = 0;
    let totalStock_base = 0;
    let totalReturnValue_base = 0;

    baseData.forEach(r => {
        // เดิมเคยกรอง r.Qty6Month > 0 ตอนนี้ไม่กรองแล้ว
        totalStock_base += r.Value;
        totalReturnValue_base += r.ReturnValue;
        if (r.Unrestricted > 0) {
            const unit_price = r.Value / r.Unrestricted;
            total_usage_4m_base += r.Qty4Month * unit_price;
        }
    });

    const monthly_withdrawal = total_usage_4m_base / 4 || 0;
    const daily_usage        = total_usage_4m_base / 120 || 0;
    const stock_days         = daily_usage > 0 ? Math.round(totalStock_base / daily_usage) : 'N/A';
    const after_stock_days   = daily_usage > 0 ? Math.round((totalStock_base - totalReturnValue_base) / daily_usage) : 'N/A';

    document.getElementById("monthlyWithdrawalValue").textContent = formatShortCurrency(monthly_withdrawal);
    document.getElementById("stockDaysValue").textContent         = stock_days > 9999 ? 'มาก' : stock_days;
    document.getElementById("afterStockDaysValue").textContent    = after_stock_days > 9999 ? 'มาก' : after_stock_days;
}

function getStatusClass(status){
    if(!status||status.trim()==='')return "status-other";
    const s=status.toLowerCase();
    if(s.includes('pending')||s.includes('รอดำเนินการ'))return "status-pending";
    if(s.includes('approved')||s.includes('อนุมัติ')||s.includes('approve'))return "status-approved";
    if(s.includes('rejected')||s.includes('ปฏิเสธ')||s.includes('reject'))return "status-rejected";
    if(s.includes('complete')||s.includes('เสร็จสิ้น')||s.includes('completed'))return "status-approved";
    if(s.includes('active')||s.includes('ใช้งาน'))return "status-approved";
    return "status-other";
}

function renderTable(){
    const container=document.getElementById("dataList");
    container.innerHTML="";
    const start=(currentPage-1)*rowsPerPage;
    const end=start+rowsPerPage;
    const pageData=filteredData.slice(start,end);
    if(pageData.length===0){
        container.innerHTML=`<tr><td colspan="30" style="text-align:center;padding:50px;color:#95a5a6;font-size:16px;">ไม่มีข้อมูลตามเงื่อนไข</td></tr>`;
        return;
    }
    pageData.forEach(r=>{
        const orderQty = Math.round(r.RecommendedOrder || 0);
const actual   = Math.round(r.ActualOrder || 0);

let orderClass;
if (actual < orderQty) {
    orderClass = "order-less";   // แดง
} else if (actual > orderQty) {
    orderClass = "order-more";   // น้ำเงิน
} else {
    orderClass = "order-equal";  // เขียว
}

        const statusClass=getStatusClass(r.Status);
        const displayStatus=r.Status&&r.Status.trim()!==''?r.Status:"-";
        const ownerDisplay=r.OwnerName||(r.OwnerId||"-");
        const navClass = (Number(r.Navanakorn || 0) === 0) ? "nava-red" : "nava-orange";
        const navanakornHtml = `<span class="${navClass}">${formatNumber(r.Navanakorn || 0)}</span>`;

        let stockClass = "stock-green";
        if (r.Unrestricted == 0 && r.Moving === "Fast") {
            stockClass = "stock-red";
        }
        const unrestrictedHtml = `
            <span class="${stockClass}">${formatNumber(r.Unrestricted)}</span>
        `;

        const row=document.createElement("tr");
        row.innerHTML = `
    <td></td>
    <td>${r.Plant}</td>
    <td>${r.Material}</td>
    <td>${r.Description}</td>
    <td>${r.StorageBin}</td>
    <td>${r.Unit}</td>
    <td>${navanakornHtml}</td>
    <td>${unrestrictedHtml}</td>
    <td><span class="value">${formatCurrency(r.Value)}</span></td>
    <td>${formatNumber(r.Qty6Month)}</td>
    <td>${formatNumber(r.Qty4Month)}</td>
    <td>${r.AvgMonthly.toLocaleString('th-TH',{minimumFractionDigits:1,maximumFractionDigits:1})}</td>
    <td>${formatNumber(r.ThirtyDay)}</td>
    <td>${r.Mean.toLocaleString('th-TH',{minimumFractionDigits:1,maximumFractionDigits:1})}</td>
    <td>${formatNumber(r.SafetyStock)}</td>
    <td>${formatNumber(r.ROP)}</td>
    <td>${r.DOS>9999?'มาก':r.DOS.toFixed(1)}</td>
   <td>
    <span class="order-span ${orderClass}">
        ${formatNumber(orderQty)}
    </span>
</td>


    <!-- ★ คอลัม “สั่งจริง” -->
   <td>
    <input type="number"
           class="actual-order-input"
           min="0"
           value="${(r.ActualOrder ?? r.RecommendedOrder) ?? ''}"
           style="width:80px;padding:4px 6px;border-radius:6px;border:1px solid #ccd1ff;text-align:right;">
</td>



    <td>${r.Note}</td>
    <td>${formatNumber(r.MultiplyUnit)}</td>
    <td>${r.Product}</td>
    <td><strong>${r.ABCValue}</strong></td>
    <td><span class="moving-${r.Moving.toLowerCase()}">${r.Moving}</span></td>
    <td><span class="return-qty">${formatNumber(r.ReturnQty)}</span></td>
    <td>${r.CumPercent.toFixed(1)}%</td>
    <td class="col-location">${r.Location||''}</td>
    <td class="col-shelf">${r.Shelf||''}</td>
    <td class="responsible-cell"><span class="responsible-user">${ownerDisplay}</span></td>
    <td><span class="${statusClass}">${displayStatus}</span></td>
`;
const actualInput = row.querySelector('input.actual-order-input');
if (actualInput) {
    actualInput.addEventListener('input', (e) => {
        const v = parseFloat(e.target.value);
        const act = isNaN(v) ? 0 : v;
        r.ActualOrder = act;
        r._actualOrderTouched = true;       // ★ บอกว่า user เคยแก้แล้ว

        // ถ้าคุณมี localStorage ตามคำตอบก่อนหน้า
        if (typeof saveActualOrdersToLocalStorage === 'function') {
            saveActualOrdersToLocalStorage();
        }

        // ★ อัปเดตสีของ "แนะนำสั่ง" ในแถวนี้ทันที
        const rec = Math.round(r.RecommendedOrder || 0);
        const span = row.querySelector('.order-span');
        if (span) {
            span.classList.remove('order-less','order-more','order-equal');
            let cls;
            if (act < rec)      cls = 'order-less';
            else if (act > rec) cls = 'order-more';
            else                cls = 'order-equal';
            span.classList.add(cls);
        }
    });
}

        // ★ ปุ่มตะกร้าในคอลัมน์แรก
        const cartCell = row.cells[0];
        const cartBtn = document.createElement('button');
        cartBtn.className = "icon-btn";
        cartBtn.title = "เพิ่มลงตะกร้า";
        cartBtn.innerHTML = '<i class="fas fa-cart-plus"></i>';
        cartBtn.addEventListener('click', () => {
            addToCart({
                Material: r.Material,
                Description: r.Description,
                StorageBin: r.StorageBin
            });
        });
        cartCell.appendChild(cartBtn);

        container.appendChild(row);
    });
}

function renderPagination(){
    const totalPages=Math.max(1,Math.ceil(filteredData.length/rowsPerPage));
    const p=document.getElementById("pagination");
    p.innerHTML="";
    const createBtn=(text,page,disabled=false)=>{
        const btn=document.createElement("button");
        btn.className="page-btn";
        if(page===currentPage)btn.classList.add("active");
        btn.textContent=text;
        btn.disabled=disabled;
        if(!disabled)btn.onclick=()=>{currentPage=page;renderTable();renderPagination();};
        return btn;
    };
    p.appendChild(createBtn("<<",1,currentPage===1));
    p.appendChild(createBtn("<",currentPage-1,currentPage===1));
    p.appendChild(createBtn(currentPage,currentPage,true));
    p.appendChild(createBtn(">",currentPage+1,currentPage===totalPages));
    p.appendChild(createBtn(">>",totalPages,currentPage===totalPages));
}
function getOrderStorageKey() {
    // ถ้าอยากแยกตาม Plant
    return 'abc_actual_orders_' + (selectedPlant || 'ALL');
}

function saveActualOrdersToLocalStorage() {
  const map = {};
  allData.forEach(r => {
    if (r._actualOrderTouched) { // เคยแก้แล้ว
      const key = `${r.Plant}-${r.Material}`;
      map[key] = Number(r.ActualOrder || 0);
    }
  });
  localStorage.setItem(getOrderStorageKey(), JSON.stringify(map));
}
function setActualOrderFromRecommended() {

    if (!Array.isArray(filteredData) || filteredData.length === 0) {
        alert("ไม่มีรายการให้ตั้งค่า");
        return;
    }

    // ตั้งค่าเฉพาะแถวที่มองเห็น (filteredData)
    filteredData.forEach(r => {
        r.ActualOrder = Math.round(r.RecommendedOrder || 0);
        r._actualOrderTouched = true;
    });

    // บันทึกลง localStorage
    saveActualOrdersToLocalStorage();

    // รีเฟรชตาราง + การ์ด
    applyFiltersAndRender();
}


function loadActualOrdersFromLocalStorage() {
    const txt = localStorage.getItem(getOrderStorageKey());
    if (!txt) return;

    let map;
    try {
        map = JSON.parse(txt) || {};
    } catch (e) {
        console.error('loadActualOrders error', e);
        return;
    }
    allData.forEach(r => {
        const key = `${r.Plant}-${r.Material}`;
        if (map[key] != null) {
            r.ActualOrder = map[key];
            r._actualOrderTouched = true;   // เคยแก้แล้ว → อย่าให้ default ทับ
        }
    });
}


function exportToCSV(){
    const headers=[
    "Plant","Material","รายการอะไหล่","Storage bin",
    "หน่วย","นวนคร","คงเหลือ","มูลค่า","ใช้ 6 เดือน","ใช้ 4 เดือน",
    "เฉลี่ย/ด.","30Day","Mean","Safety","ROP","DOS","แนะนำสั่งซื้อ",
    "สั่งจริง",             // ★ เพิ่ม
    "หมายเหตุ","คูณหน่วย","Product","ABC","Moving",
    "ส่งคืนได้ (ชิ้น)","% สะสม",
    "Location","Shelf","ผู้รับคืน","Status"
];
    let csv="\uFEFF"+headers.join(",")+"\n";
    filteredData.forEach(r=>{
        const row=[
    r.Plant,r.Material,(r.Description||"").replace(/"/g,'""'),r.StorageBin,r.Unit,r.Navanakorn || 0,
    r.Unrestricted,r.Value,r.Qty6Month,r.Qty4Month,
    r.AvgDailyUse.toFixed(1),r.ThirtyDay,r.Mean.toFixed(1),Math.round(r.SafetyStock),Math.round(r.ROP),
    r.DOS>9999?"มาก":r.DOS.toFixed(1),Math.round(r.RecommendedOrder),

    r.ActualOrder || 0,   // ★ คอลัมสั่งจริง

    r.Note,r.MultiplyUnit,r.Product,r.ABCValue,r.Moving,
    r.ReturnQty,r.CumPercent.toFixed(2),
    r.Location||"",r.Shelf||"",r.OwnerName||r.OwnerId||"",r.Status||""
];

        csv+=row.map(v=>`"${v}"`).join(",")+"\n";
    });
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;a.download=`ABC_Analysis_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();URL.revokeObjectURL(url);
}

document.getElementById("cardTotalStock").onclick=()=>{mode="all";abcFilter="";movingFilter="";applyFiltersAndRender();};
document.getElementById("cardOrderItems").onclick=()=>{mode="onlyOrder";abcFilter="";movingFilter="";applyFiltersAndRender();};
document.getElementById("cardReturnValue").onclick=()=>{mode="returnable";abcFilter="";movingFilter="";applyFiltersAndRender();};

document.getElementById("abcA").onclick=()=>{abcFilter="A";movingFilter="";applyFiltersAndRender();};
document.getElementById("abcB").onclick=()=>{abcFilter="B";movingFilter="";applyFiltersAndRender();};
document.getElementById("abcC").onclick=()=>{abcFilter="C";movingFilter="";applyFiltersAndRender();};

document.getElementById("cardFast").onclick=()=>{movingFilter="Fast";abcFilter="";applyFiltersAndRender();};
document.getElementById("cardMedium").onclick=()=>{movingFilter="Medium";abcFilter="";applyFiltersAndRender();};
document.getElementById("cardSlow").onclick=()=>{movingFilter="Slow";abcFilter="";applyFiltersAndRender();};
document.getElementById("cardSlowly").onclick=()=>{movingFilter="Slowly";abcFilter="";applyFiltersAndRender();};
document.getElementById("cardDead").onclick=()=>{movingFilter="Dead";abcFilter="";applyFiltersAndRender();};

document.getElementById("plantFilter").addEventListener("change",applyFiltersAndRender);
document.getElementById("statusFilter").addEventListener("change",applyFiltersAndRender);
document.getElementById("responsibleFilter").addEventListener("change",applyFiltersAndRender);
["leadTimeDays","safetyDays","coverDays","searchInput"].forEach(id=>{
    document.getElementById(id).addEventListener("input",applyFiltersAndRender);
});
document.getElementById("orderDiffFilter").addEventListener("change", applyFiltersAndRender);
document.getElementById("setActualBtn").addEventListener("click", setActualOrderFromRecommended);
document.getElementById("exportBtn").onclick=exportToCSV;
</script>
</body>
</html> 
