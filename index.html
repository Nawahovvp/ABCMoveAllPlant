<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบวิเคราะห์ ABC อะไหล่ (เวอร์ชันสวยสุด)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
       body { font-family: "Prompt", "Segoe UI", sans-serif; margin: 0; background: #f5f7fa; padding: 10px; }
        .container { max-width: 1920px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        h1 { text-align: center; color: white; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); font-size: 26px; margin: 0; }
        .subtitle { text-align: center; color: #888; font-size: 15px; padding: 10px 0; background: #f8f9fa; margin: 0; }

        /* Card เล็กลง + สวย */
        .summary-row { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; padding: 16px; background: #f8f9fa; }
        .card { flex: 1 1 160px; min-width: 160px; padding: 14px; border-radius: 14px; text-align: center; color: white; cursor: pointer; transition: all 0.3s; box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .card:hover { transform: translateY(-6px); }
        .card-title { font-size: 13px; opacity: 0.95; margin-bottom: 6px; }
        .card-value { font-size: 24px; font-weight: 900; margin: 6px 0; }
        .card-count { font-size: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 3px 8px; }

        .total-stock { background: linear-gradient(135deg, #2c3e50, #34495e); }
        .order-items { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .return-value { background: linear-gradient(135deg, #e67e22, #d35400); }
        .after-return { background: linear-gradient(135deg, #27ae60, #1e8449); }
        .abc-a, .abc-b, .abc-c, .fast, .medium, .slow, .dead { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
.controls { padding: 20px; background: #fff; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; border-bottom: 1px solid #eee; }
        .control-group { display: flex; align-items: center; gap: 10px; background: #f1f3f5; padding: 10px 18px; border-radius: 12px; font-size: 14px; }
        label { font-weight: 600; color: #2c3e50; }
        select, input[type=number] { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; font-size: 14px; }
        .export-btn { padding: 12px 24px; background: linear-gradient(135deg, #27ae60, #1e8449); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 6px 15px rgba(39,174,96,0.4); }
        .export-btn:hover { transform: translateY(-3px); }

        /* ตารางแบบ Card List + Sticky Header */
        .table-container { max-height: 70vh; overflow: auto; position: relative; }
        .table-header {
            position: sticky; top: 0; z-index: 10; background: #667eea; color: white; font-weight: bold;
            display: grid; grid-template-columns: 70px 110px 1fr 80px 100px 110px 90px 90px 90px 80px 90px 80px 110px 60px 90px 100px 80px;
            gap: 10px; padding: 14px 16px; border-radius: 12px 12px 0 0; font-size: 13px;
        }
        .table-header div { cursor: pointer; user-select: none; }
        .table-header div:hover { opacity: 0.8; }
        .sort-icon { margin-left: 4px; font-size: 10px; }

        .item-card {
            display: grid; grid-template-columns: 70px 110px 1fr 80px 100px 110px 90px 90px 90px 80px 90px 80px 110px 60px 90px 100px 80px;
            gap: 10px; align-items: center; padding: 12px 16px; background: white; border-bottom: 1px solid #eee; font-size: 13px;
            transition: background 0.2s;
        }
        .item-card:hover { background: #f0f8ff; }
        .item-card:nth-child(even) { background: #f8f9fa; }

        .value { background: #667eea; color: white; padding: 4px 8px; border-radius: 8px; font-weight: bold; font-size: 12px; }
        .order-0 { color: #95a5a6; }
        .order-1-10 { background: #d5f5e3; color: #1e8449; padding: 4px 8px; border-radius: 6px; }
        .order-11-50 { background: #fef9e7; color: #d35400; padding: 4px 8px; border-radius: 6px; }
        .order-51-200 { background: #fdecea; color: #c0392b; padding: 4px 8px; border-radius: 6px; }
        .order-200 { background: #fadbd8; color: #c0392b; padding: 4px 8px; border-radius: 6px; font-weight: bold; }

        .moving-fast, .moving-medium, .moving-slow, .moving-dead {
            padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold;
        }
        .moving-fast { background: #d5f5e3; color: #1e8449; }
        .moving-medium { background: #fef9e7; color: #d35400; }
        .moving-slow { background: #fdecea; color: #c0392b; }
        .moving-dead { background: #f0f0f0; color: #7f8c8d; }

        .pagination { padding: 16px; text-align: center; background: #f8f9fa; font-size: 16px; font-weight: bold; color: #2c3e50; }
        .page-btn { padding: 8px 14px; margin: 0 4px; background: white; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; }
        .page-btn.active { background: #667eea; color: white; border: none; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        /* จัดข้อความในคอลัมน์ตัวเลขให้อยู่กึ่งกลาง */
.item-card > :nth-child(5),
.item-card > :nth-child(6),
.item-card > :nth-child(7),
.item-card > :nth-child(8),
.item-card > :nth-child(9),
.item-card > :nth-child(10),
.item-card > :nth-child(11),
.item-card > :nth-child(12),
.item-card > :nth-child(13),
.item-card > :nth-child(14),
.item-card > :nth-child(17),
.item-card > :nth-child(18),
.table-header > :nth-child(5),
.table-header > :nth-child(6),
.table-header > :nth-child(7),
.table-header > :nth-child(8),
.table-header > :nth-child(9),
.table-header > :nth-child(10),
.table-header > :nth-child(11),
.table-header > :nth-child(12),
.table-header > :nth-child(13),
.table-header > :nth-child(14),
.table-header > :nth-child(17),
.table-header > :nth-child(18) {
    text-align: center;
}
    </style>
 <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <h1>ระบบวิเคราะห์ ABC อะไหล่ + สั่งซื้ออัจฉริยะ</h1>
    <p class="subtitle">Plant 0366 • คลิกการ์ดเพื่อกรองทันที</p>

    <!-- Card เงินสั้น ๆ -->
   <div class="summary-row">
        <div class="card total-stock" id="cardTotalStock">
            <div class="card-title">มูลค่ารวม</div>
            <div class="card-value" id="totalStockValue">0.00</div>
            <div class="card-count" id="totalCount">0 รายการ</div>
        </div>
        <div class="card order-items" id="cardOrderItems">
            <div class="card-title">Order</div>
            <div class="card-value" id="orderItemCount">0 </div>
            <div class="card-value" id="orderTotalValue">0.00</div>
        </div>
        <div class="card return-value" id="cardReturnValue">
            <div class="card-title">OverStock</div>
            <div class="card-value" id="returnValue">0.00</div>
            <div class="card-count" id="returnItemCount">0 รายการ</div>
        </div>
        <div class="card after-return" id="cardAfterReturn">
            <div class="card-title">After Value</div>
            <div class="card-value" id="afterReturnValue">0.00</div>
        </div>
    </div>

    <!-- ABC + Moving -->
    <div class="summary-row">
        <div class="card abc-a" id="abcA"><div class="card-title">กลุ่ม A</div><div class="card-value" id="sumA">0.00</div><div class="card-count" id="countA">0 รายการ</div></div>
        <div class="card abc-b" id="abcB"><div class="card-title">กลุ่ม B</div><div class="card-value" id="sumB">0.00</div><div class="card-count" id="countB">0 รายการ</div></div>
        <div class="card abc-c" id="abcC"><div class="card-title">กลุ่ม C</div><div class="card-value" id="sumC">0.00</div><div class="card-count" id="countC">0 รายการ</div></div>
        <div class="card fast" id="cardFast"><div class="card-title">Fast Moving</div><div class="card-value" id="valFast">0.00</div><div class="card-count" id="countFast">0 รายการ</div></div>
        <div class="card medium" id="cardMedium"><div class="card-title">Medium</div><div class="card-value" id="valMedium">0.00</div><div class="card-count" id="countMedium">0 รายการ</div></div>
        <div class="card slow" id="cardSlow"><div class="card-title">Slow Moving</div><div class="card-value" id="valSlow">0.00</div><div class="card-count" id="countSlow">0 รายการ</div></div>
        <div class="card dead" id="cardDead"><div class="card-title">Dead Stock</div><div class="card-value" id="valDead">0.00</div><div class="card-count" id="countDead">0 รายการ</div></div>
    </div>

    <div class="controls">
        <div class="control-group"><label>Plant:</label><select id="plantFilter"><option value="">ทุก Plant</option></select></div>
        <div class="control-group"><label>Lead Time:</label><input type="number" id="leadTimeDays" value="5"> วัน</div>
        <div class="control-group"><label>Safety:</label><input type="number" id="safetyDays" value="20"> วัน</div>
        <div class="control-group"><label>ครอบคลุม:</label><input type="number" id="coverDays" value="45"> วัน</div>
        <button class="export-btn" id="exportBtn">Export Excel</button>
    </div>

    <div class="table-container">
        <div class="table-header" id="tableHeader">
            <div data-sort="Plant">Plant <i class="fas fa-sort sort-icon"></i></div>
            <div data-sort="Material">Material <i class="fas fa-sort sort-icon"></i></div>
            <div>รายการอะไหล่</div>
            <div data-sort="Unit">หน่วย</div>
            <div data-sort="Unrestricted">คงเหลือ <i class="fas fa-sort sort-icon"></i></div>
            <div data-sort="Value">มูลค่า <i class="fas fa-sort sort-icon"></i></div>
            <div data-sort="Qty6Month">เบิก 6ด.</div>
            <div data-sort="Qty4Month">เบิก 4ด.</div>
            <div data-sort="AvgMonthly">เฉลี่ย/ด.</div>
            <div data-sort="SafetyStock">Safety</div>
            <div data-sort="ROP">ROP <i class="fas fa-sort sort-icon"></i></div>
            <div data-sort="DOS">DOS</div>
            <div data-sort="RecommendedOrder">แนะนำสั่งซื้อ <i class="fas fa-sort sort-icon"></i></div>
            <div data-sort="ABCValue">ABC</div>
            <div data-sort="Moving">Moving</div>
            <div data-sort="ReturnQty">ส่งคืน</div>
            <div data-sort="CumPercent">%สะสม <i class="fas fa-sort sort-icon"></i></div>
        </div>
        <div id="dataList"></div>
    </div>

    <div class="pagination" id="pagination"></div>
</div>

<script>
// ฟังก์ชันแปลงตัวเลขเป็น K / M
function formatShortCurrency(n) {
    if (n >= 1e9) return (n / 1e9).toFixed(2) + " พันล้าน";
    if (n >= 1e6) return (n / 1e6).toFixed(2) + " M";
    if (n >= 1e3) return (n / 1e3).toFixed(2) + " K";
    return n.toFixed(2);
}
let sortKey = "CumPercent", sortDir = "asc";

document.addEventListener("DOMContentLoaded", function () {
    const usageUrl = 'https://opensheet.elk.sh/1P8Frv1zvcuO3qt8seU-zMF0FV0TQHyKXLn9GNHVr6kI/MoveAllsum';
    const inventoryUrl = 'https://opensheet.elk.sh/1OtcgbmQdrI3gKJCGiDge6xuOsrT0GPxdKeFPjpvK3Rg/Sheet1';
    let allData = [], filteredData = [];
    let mode = "all", abcFilter = "", movingFilter = ""; // ใช้ตัวแปรแยก
    let currentPage = 1;
    const rowsPerPage = 25;

    function toNumber(v) { return parseFloat((v||"0").toString().replace(/,/g,'')) || 0; }
    function formatNumber(n) { return Number(n).toLocaleString('th-TH'); }
    function formatCurrency(n) { return Number(n).toLocaleString('th-TH', {minimumFractionDigits:2, maximumFractionDigits:2}); }

    function calculateKeepQty(r) {
        const avg = r.AvgDailyUse;
        if (r.Moving === "Dead") return 1;
        if (r.Moving === "Slow" && r.ABCValue === "C") return Math.max(1, Math.round(avg * 60));
        if (r.Moving === "Slow" && r.ABCValue === "B") return Math.max(1, Math.round(avg * 60));
        if (r.Moving === "Medium" && r.ABCValue === "C") return Math.max(2, Math.round(avg * 60));
        if (r.Moving === "Slow" && r.ABCValue === "A") return Math.max(3, Math.round(avg * 60));
        if (r.Moving === "Medium" && r.ABCValue === "B") return Math.max(4, Math.round(avg * 60));
        if (r.Moving === "Fast" && r.ABCValue === "C") return Math.max(5, Math.round(avg * 60));
        if (r.Moving === "Medium" && r.ABCValue === "A") return Math.max(6, Math.round(avg * 75));
        if (r.Moving === "Fast" && r.ABCValue === "B") return Math.max(8, Math.round(avg * 90));
        if (r.Moving === "Fast" && r.ABCValue === "A") return Math.max(10, Math.round(avg * 120));
        return Math.max(1, Math.round(avg * 40));
    }

    async function loadData() {
        try {
            const [uRes, iRes] = await Promise.all([fetch(usageUrl), fetch(inventoryUrl)]);
            const usage = await uRes.json();
            const inv = await iRes.json();
            const useMap = new Map();
            usage.forEach(r => useMap.set(`${r.Plant?.trim()}-${r.Material?.trim()}`, r));

            allData = inv.map(r => {
                const key = `${r.Plant?.trim()}-${r.Material?.trim()}`;
                const u = useMap.get(key) || {Qtyissu:0, Qtyissu6m:0};
                const qty4m = toNumber(u.Qtyissu);
                const qty6m = toNumber(u.Qtyissu6m) || Math.round(qty4m * 1.5);
                return {
                    Plant: (r.Plant||'').trim(),
                    Material: (r.Material||'').trim(),
                    Description: r["Material description"] || '',
                    Unit: r["Base Unit of Measure"] || '',
                    Unrestricted: toNumber(r.Unrestricted),
                    Value: toNumber(r["Value Unrestricted"]),
                    Qty6Month: qty6m,
                    Qty4Month: qty4m,
                    AvgMonthly: qty4m / 4,
                    AvgDailyUse: qty4m / 120,
                    SafetyStock:0, ROP:0, DOS:0, RecommendedOrder:0,
                    ABCValue:"", CumPercent:0, Moving:"", IsNonMoving: qty4m === 0,
                    ReturnQty: 0, ReturnValue: 0
                };
            });
            calcABCValue();
            fillPlantDropdown();
            setDefaultAndCalculate();
        } catch(e) { alert("โหลดข้อมูลไม่สำเร็จ"); console.error(e); }
    }

    function calcABCValue() {
        const sorted = [...allData].sort((a,b)=>b.Value-a.Value);
        const total = sorted.reduce((s,r)=>s+r.Value,0);
        let cum = 0;
        sorted.forEach(r => {
            cum += r.Value;
            const pct = total ? (cum/total)*100 : 0;
            const orig = allData.find(x=>x.Material===r.Material && x.Plant===r.Plant);
            if(orig){
                orig.CumPercent = pct;
                orig.ABCValue = pct <= 70 ? "A" : pct <= 90 ? "B" : "C";
            }
        });
    }

    // 1. แก้ recalculateStockFields ให้ return ค่ากลับมา
// 1. แก้ recalculateStockFields ให้ return ค่ากลับมา
function recalculateStockFields(data, params) {
    let totalReturnValue = 0;
    let totalAfterReturn = 0;

    data.forEach(r => {
        const d = r.AvgDailyUse || 0;
        const leadTime = params.leadTime || 5;
        const safetyDays = params.safety || 3;
        const coverDays = params.cover || 40;

        const safetyStock = d * safetyDays;
        const rop = (d * leadTime) + safetyStock;
        const dos = d > 0 ? r.Unrestricted / d : 9999;

        r.SafetyStock = Math.round(safetyStock);
        r.ROP = Math.round(rop);
        r.DOS = dos > 9999 ? 9999 : parseFloat(dos.toFixed(1));

        // สูตรสั่งซื้อใหม่: เฉพาะเมื่อต่ำกว่า ROP
        let recommend = 0;
        if (r.Unrestricted < rop) {
            const needed = d * coverDays;
            recommend = needed - r.Unrestricted;
            if (recommend < 0) recommend = 0;
        }
        r.RecommendedOrder = Math.round(recommend);

       // กำหนด Moving จาก AvgMonthly (เฉลี่ย/เดือน)
if (r.IsNonMoving || r.AvgMonthly <= 0) {
    r.Moving = "Dead";
} else if (r.AvgMonthly >= 100) {
    r.Moving = "Fast";
} else if (r.AvgMonthly >= 10) {
    r.Moving = "Medium";
} else {
    r.Moving = "Slow";
}
        // ส่งคืน
        const keepQty = calculateKeepQty(r);
        const returnQty = Math.max(0, r.Unrestricted - keepQty);
        const unitPrice = r.Unrestricted > 0 ? r.Value / r.Unrestricted : 0;
        const returnValue = returnQty * unitPrice;

        r.ReturnQty = Math.round(returnQty);
        r.ReturnValue = returnValue;

        totalReturnValue += returnValue;
        totalAfterReturn += (r.Value - returnValue);
    });

    // ส่งค่ากลับ
    return { totalReturnValue, totalAfterReturn };
}
    function fillPlantDropdown() {
        const sel = document.getElementById("plantFilter");
        const plants = [...new Set(allData.map(r=>r.Plant))].filter(Boolean).sort();
        sel.innerHTML = '<option value="">ทุก Plant</option>';
        plants.forEach(p => sel.add(new Option(p,p)));
    }

    function setDefaultAndCalculate() {
        const sel = document.getElementById("plantFilter");
        if (sel.querySelector('[value="0366"]')) sel.value = "0366";
        mode = "all"; abcFilter = ""; movingFilter = "";
        applyFiltersAndRender();
    }
document.getElementById("tableHeader").addEventListener("click", function(e) {
        const col = e.target.closest("[data-sort]");
        if (!col) return;
        const key = col.getAttribute("data-sort");
        if (sortKey === key) {
            sortDir = sortDir === "asc" ? "desc" : "asc";
        } else {
            sortKey = key;
            sortDir = "desc";
        }
        applyFiltersAndRender();
    });
    // 2. แก้ applyFiltersAndRender ให้รับค่ากลับมา
function applyFiltersAndRender() {
    let data = [...allData];
    const plant = document.getElementById("plantFilter").value;
    if (plant) data = data.filter(r => r.Plant === plant);

    const params = {
        leadTime: parseInt(document.getElementById("leadTimeDays").value) || 5,
        safety: parseInt(document.getElementById("safetyDays").value) || 3,
        cover: parseInt(document.getElementById("coverDays").value) || 40
    };

    // รับค่ากลับมาจากฟังก์ชัน
    const { totalReturnValue, totalAfterReturn } = recalculateStockFields(data, params);

    // กรอง mode
    if (mode === "onlyOrder") data = data.filter(r => Math.round(r.RecommendedOrder) >= 1);
    else if (mode === "returnable") data = data.filter(r => r.ReturnQty > 0);
    else if (mode === "afterReturn") data = data.map(r => ({...r, Unrestricted: r.Unrestricted - r.ReturnQty}));

    if (abcFilter) data = data.filter(r => r.ABCValue === abcFilter);
    if (movingFilter) data = data.filter(r => r.Moving === movingFilter);

    data.sort((a,b) => b.Value - a.Value);
    filteredData = data;
    currentPage = 1;

    // อัปเดต Card ส่งคืน (ใช้ค่าที่รับมา)
    document.getElementById("returnValue").textContent = formatShortCurrency(totalReturnValue);
    document.getElementById("afterReturnValue").textContent = formatShortCurrency(totalAfterReturn);
filteredData.sort((a, b) => {
            let x = a[sortKey] || 0;
            let y = b[sortKey] || 0;
            if (typeof x === "string") x = x.toLowerCase();
            if (typeof y === "string") y = y.toLowerCase();
            return sortDir === "asc" ? (x > y ? 1 : -1) : (x < y ? 1 : -1);
        });

        currentPage = 1;
        renderTable();
        renderPagination();
        updateAllCards();
    }
   // 3. แก้ updateAllCards ให้ไม่ใช้ totalReturnValue อีก (เพราะอัปเดตไปแล้ว)
function updateAllCards() {
    const data = filteredData;
    const abc = {A:0,B:0,C:0}, cntABC = {A:0,B:0,C:0};
    const mov = {Fast:0,Medium:0,Slow:0,Dead:0}, cntMov = {Fast:0,Medium:0,Slow:0,Dead:0};
    let totalStock = 0, orderItems = 0, orderValue = 0, returnCount = 0;

    data.forEach(r => {
        totalStock += r.Value;
        abc[r.ABCValue] += r.Value; cntABC[r.ABCValue]++;
        mov[r.Moving] += r.Value; cntMov[r.Moving]++;

        const qty = Math.round(r.RecommendedOrder);
        if (qty > 0) { 
            orderItems++; 
            orderValue += qty * (r.Unrestricted > 0 ? r.Value / r.Unrestricted : 0); 
        }
        if (r.ReturnQty > 0) returnCount++;
    });

    // แสดงเป็น K/M
    document.getElementById("totalStockValue").textContent = formatShortCurrency(totalStock);
    document.getElementById("orderTotalValue").textContent = formatShortCurrency(orderValue);

    document.getElementById("sumA").textContent = formatShortCurrency(abc.A);
    document.getElementById("sumB").textContent = formatShortCurrency(abc.B);
    document.getElementById("sumC").textContent = formatShortCurrency(abc.C);
    document.getElementById("valFast").textContent = formatShortCurrency(mov.Fast);
    document.getElementById("valMedium").textContent = formatShortCurrency(mov.Medium);
    document.getElementById("valSlow").textContent = formatShortCurrency(mov.Slow);
    document.getElementById("valDead").textContent = formatShortCurrency(mov.Dead);

    document.getElementById("totalCount").textContent = data.length + " รายการ";
    document.getElementById("orderItemCount").textContent = orderItems;
    document.getElementById("returnItemCount").textContent = returnCount + " รายการ";
    document.getElementById("countA").textContent = cntABC.A + " รายการ";
    document.getElementById("countB").textContent = cntABC.B + " รายการ";
    document.getElementById("countC").textContent = cntABC.C + " รายการ";
    document.getElementById("countFast").textContent = cntMov.Fast + " รายการ";
    document.getElementById("countMedium").textContent = cntMov.Medium + " รายการ";
    document.getElementById("countSlow").textContent = cntMov.Slow + " รายการ";
    document.getElementById("countDead").textContent = cntMov.Dead + " รายการ";
}
    function renderTable() {
        const container = document.getElementById("dataList");
        container.innerHTML = "";
        const start = (currentPage-1)*25;
        const end = start + 25;
        const pageData = filteredData.slice(start, end);

        if (pageData.length === 0) {
            container.innerHTML = `<div style="text-align:center;padding:50px;color:#95a5a6;font-size:16px;">ไม่มีข้อมูลตามเงื่อนไข</div>`;
            return;
        }

        pageData.forEach(r => {
            const orderQty = Math.round(r.RecommendedOrder);
            const orderClass = orderQty === 0 ? "order-0" :
                              orderQty <= 10 ? "order-1-10" :
                              orderQty <= 50 ? "order-11-50" :
                              orderQty <= 200 ? "order-51-200" : "order-200";

            const card = document.createElement("div");
            card.className = "item-card";
            card.innerHTML = `
                <div>${r.Plant}</div>
                <div class="material">${r.Material}</div>
                <div class="desc">${r.Description}</div>
                <div>${r.Unit}</div>
                <div>${formatNumber(r.Unrestricted)}</div>
                <div class="value">${formatCurrency(r.Value)}</div>
                <div>${formatNumber(r.Qty6Month)}</div>
                <div>${formatNumber(r.Qty4Month)}</div>
                <div>${formatNumber(Math.round(r.AvgMonthly))}</div>
                <div>${formatNumber(r.SafetyStock)}</div>
                <div>${formatNumber(r.ROP)}</div>
                <div>${r.DOS>9999?'มาก':r.DOS.toFixed(1)}</div>
                <div class="${orderClass} order">${formatNumber(orderQty)}</div>
                <div><strong>${r.ABCValue}</strong></div>
                <div class="moving-${r.Moving.toLowerCase()}">${r.Moving}</div>
                <div style="background:#e74c3c;color:white;padding:2px 8px;border-radius:6px;">${formatNumber(r.ReturnQty)}</div>
                <div>${r.CumPercent.toFixed(1)}%</div>
            `;
            container.appendChild(card);
        });
    }
    function renderPagination() {
        const totalPages = Math.max(1, Math.ceil(filteredData.length / 25));
        const p = document.getElementById("pagination");
        p.innerHTML = "";

        const createBtn = (text, page, disabled = false) => {
            const btn = document.createElement("button");
            btn.className = "page-btn";
            if (page === currentPage) btn.classList.add("active");
            btn.textContent = text;
            btn.disabled = disabled;
            if (!disabled) btn.onclick = () => { currentPage = page; renderTable(); renderPagination(); };
            return btn;
        };

        p.appendChild(createBtn("<<", 1, currentPage === 1));
        p.appendChild(createBtn("<", currentPage - 1, currentPage === 1));
        p.appendChild(createBtn(currentPage, currentPage, true));
        p.appendChild(createBtn(">", currentPage + 1, currentPage === totalPages));
        p.appendChild(createBtn(">>", totalPages, currentPage === totalPages));
    }

    function exportToCSV() {
        const headers = ["Plant","Material","รายการอะไหล่","หน่วย","คงเหลือ","มูลค่า","ใช้ 6 เดือน","ใช้ 4 เดือน","เฉลี่ย/เดือน","Safety","ROP","DOS","แนะนำสั่งซื้อ","ABC","Moving","ส่งคืนได้ (ชิ้น)","% สะสม"];
        let csv = "\uFEFF" + headers.join(",") + "\n";

        filteredData.forEach(r => {
            const row = [
                r.Plant, r.Material, r.Description.replace(/"/g, '""'), r.Unit,
                r.Unrestricted, r.Value, r.Qty6Month, r.Qty4Month,
                Math.round(r.AvgMonthly), Math.round(r.SafetyStock), Math.round(r.ROP),
                r.DOS > 9999 ? "มาก" : r.DOS.toFixed(1), Math.round(r.RecommendedOrder),
                r.ABCValue, r.Moving, r.ReturnQty, r.CumPercent.toFixed(2)
            ];
            csv += row.map(v => `"${v}"`).join(",") + "\n";
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `ABC_Analysis_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // คลิก Card หลัก - รีเซ็ต ABC/Moving filter
    document.getElementById("cardTotalStock").onclick = () => { mode = "all"; abcFilter = ""; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardOrderItems").onclick = () => { mode = "onlyOrder"; abcFilter = ""; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardReturnValue").onclick = () => { mode = "returnable"; abcFilter = ""; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardAfterReturn").onclick = () => { mode = "afterReturn"; abcFilter = ""; movingFilter = ""; applyFiltersAndRender(); };

    // คลิก Card ABC / Moving - กรองต่อเนื่อง (คง Plant + mode เดิม)
    document.getElementById("abcA").onclick = () => { abcFilter = "A"; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("abcB").onclick = () => { abcFilter = "B"; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("abcC").onclick = () => { abcFilter = "C"; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardFast").onclick = () => { movingFilter = "Fast"; abcFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardMedium").onclick = () => { movingFilter = "Medium"; abcFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardSlow").onclick = () => { movingFilter = "Slow"; abcFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardDead").onclick = () => { movingFilter = "Dead"; abcFilter = ""; applyFiltersAndRender(); };

    ["plantFilter","leadTimeDays","safetyDays","coverDays"].forEach(id => {
        document.getElementById(id).addEventListener("change", applyFiltersAndRender);
    });

    document.getElementById("exportBtn").onclick = exportToCSV;

    loadData();
});
</script>
</body>
</html>
