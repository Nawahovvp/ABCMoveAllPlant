<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบวิเคราะห์ ABC อะไหล่ (เวอร์ชันสมบูรณ์)</title>

    <!-- CSS หลักของคุณ (แยกไฟล์แล้ว) -->
    <link rel="stylesheet" href="styles.css">

    <!-- ไอคอน + ฟอนต์ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Libs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div class="container">
        <h1>ABC Analysis & Smart Ordering System</h1>
        <button id="menuBtn" style="display: none;"><i class="fas fa-user-circle"></i></button>
        <div id="userMenu">
            <p id="userID"></p>
            <p id="userName"></p>

            <!-- ✅ ปุ่ม Help -->
            <button id="helpBtn" class="export-btn"
                style="width:100%;justify-content:center;margin:8px 0;background:linear-gradient(135deg,#3498db,#2980b9);">
                <i class="fas fa-circle-info"></i> Help
            </button>

            <button id="logoutBtn">Log out</button>
        </div>

        <div class="loader" id="loader" style="display: none;"></div>
        <button id="backBtn"><i class="fas fa-arrow-left"></i></button>

        <!-- Plant Selection -->
        <div id="plantSelection"
            style="display: none; text-align: center; padding: 30px; background: linear-gradient(135deg, #f0f4ff, #e0eaff); border-radius: 20px; margin: 30px auto; max-width: 600px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">เลือกคลังสินค้า</h2>
            <div class="control-group"
                style="justify-content: center; margin: 0 auto; width: fit-content; display: flex; align-items: center; gap: 10px;">
                <label><i class="fas fa-industry control-icon"></i> Plant:</label>
                <select id="plantSelect" style="width: 250px;"></select>
                <button id="viewBtn" class="export-btn" style="padding: 10px 16px; height: fit-content;"><i
                        class="fas fa-eye"></i> View</button>
            </div>
        </div>

        <!-- Cards -->
        <div class="summary-row" id="mainCardsSection" style="display:none;">
            <div class="card total-stock" id="cardTotalStock" title="มูลค่ารวมสต็อกทั้งหมด + จำนวนรายการทั้งหมด (ตามโหมดที่เลือก)">
                <div class="card-title">มูลค่ารวม</div>
                <div class="card-value" id="totalStockValue">0.00</div>
                <div class="card-count" id="totalCount">0 รายการ</div>
            </div>
            <div class="card order-items" id="cardOrderItems" title="จำนวนรายการที่ต้องสั่ง + มูลค่ารวมของการสั่ง (ตามโหมด Order)">
                <div class="card-title">Order</div>
                <div class="card-value" id="orderItemCount">0</div>
                <div class="card-value" id="orderTotalValue">0.00</div>
            </div>
            <div class="card return-value" id="cardReturnValue" title="มูลค่ารวมของที่ส่งคืนได้ + จำนวนรายการ OverStock (ตามโหมด Return)">
                <div class="card-title">OverStock</div>
                <div class="card-value" id="returnValue">0.00</div>
                <div class="card-count" id="returnItemCount">0 รายการ</div>
            </div>
            <!-- Out of Stock -->
            <div class="card out-of-stock" id="cardOutOfStock" title="รายการที่หมดในคลังนี้แต่ยังมีในนวนคร (จำนวนรายการ + มูลค่า)">
                <div class="card-title">Out of Stock</div>
                <div class="card-value" id="countOutOfStock">0</div>
                <div class="card-value small" id="valOutOfStock">0.00</div>
            </div>

            <!-- Out of Stock Wait -->
            <div class="card out-of-stock-wait" id="cardOutOfStockWait" title="รายการที่หมดทั้งในคลังนี้และนวนคร (จำนวนรายการ + มูลค่า)">
                <div class="card-title">Out of Stock Wait</div>
                <div class="card-value" id="countOutOfStockWait">0</div>
                <div class="card-value small" id="valOutOfStockWait">0.00</div>
            </div>
            <div class="card monthly-withdrawal" id="cardMonthlyWithdrawal" title="มูลค่าการเบิกเฉลี่ยต่อเดือน (จากข้อมูล 4 เดือน)">
                <div class="card-title">เบิก/เดือน</div>
                <div class="card-value" id="monthlyWithdrawalValue">0.00</div>
            </div>
            <div class="card stock-days" id="cardStockDays" title="จำนวนวันที่สต็อกปัจจุบันเพียงพอ (Stock Days = คงเหลือ ÷ การใช้เฉลี่ยต่อวัน)">
                <div class="card-title">Stock Days</div>
                <div class="card-value" id="stockDaysValue">0</div>
            </div>
            <div class="card after-stock-days" id="cardAfterStockDays" title="จำนวนวันที่สต็อกเหลือหลังหักของส่งคืนได้ (After Return)">
                <div class="card-title">After Stock Days</div>
                <div class="card-value" id="afterStockDaysValue">0</div>
            </div>
        </div>

        <div class="summary-row" id="summarySection" style="display:none;">
            <div class="card abc-a" id="abcA" title="กลุ่ม A: มูลค่าสะสม ≤70% (สำคัญมากที่สุด)">
                <div class="card-title">กลุ่ม A</div>
                <div class="card-value" id="sumA">0.00</div>
                <div class="card-count" id="countA">0 รายการ</div>
            </div>
            <div class="card abc-b" id="abcB" title="กลุ่ม B: มูลค่าสะสม 70-90% (สำคัญรองลงมา)">
                <div class="card-title">กลุ่ม B</div>
                <div class="card-value" id="sumB">0.00</div>
                <div class="card-count" id="countB">0 รายการ</div>
            </div>
            <div class="card abc-c" id="abcC" title="กลุ่ม C: มูลค่าสะสม >90% (ทั่วไป)">
                <div class="card-title">กลุ่ม C</div>
                <div class="card-value" id="sumC">0.00</div>
                <div class="card-count" id="countC">0 รายการ</div>
            </div>
            <div class="card fast" id="cardFast" title="Fast Moving: เฉลี่ยเบิก ≥30 ชิ้น/เดือน">
                <div class="card-title">Fast Moving</div>
                <div class="card-value" id="valFast">0.00</div>
                <div class="card-count" id="countFast">0 รายการ</div>
            </div>
            <div class="card medium" id="cardMedium" title="Medium: เฉลี่ยเบิก 12-29 ชิ้น/เดือน">
                <div class="card-title">Medium</div>
                <div class="card-value" id="valMedium">0.00</div>
                <div class="card-count" id="countMedium">0 รายการ</div>
            </div>
            <div class="card slow" id="cardSlow" title="Slow Moving: เฉลี่ยเบิก 0.7-11 ชิ้น/เดือน">
                <div class="card-title">Slow Moving</div>
                <div class="card-value" id="valSlow">0.00</div>
                <div class="card-count" id="countSlow">0 รายการ</div>
            </div>
            <div class="card slowly" id="cardSlowly" title="Slowly Moving: เฉลี่ยเบิก <0.7 ชิ้น/เดือน">
                <div class="card-title">Slowly Moving</div>
                <div class="card-value" id="valSlowly">0.00</div>
                <div class="card-count" id="countSlowly">0 รายการ</div>
            </div>
            <div class="card dead" id="cardDead" title="Dead Stock: ไม่มีการเบิกเลยใน 4 เดือน">
                <div class="card-title">Dead Stock</div>
                <div class="card-value" id="valDead">0.00</div>
                <div class="card-count" id="countDead">0 รายการ</div>
            </div>
        </div>

        <div class="controls" id="controlsSection" style="display:none;">
            <div class="filter-row">
                <div class="control-group">
                    <label><i class="fas fa-industry control-icon"></i> Plant:</label>
                    <select id="plantFilter">
                        <option value="">ทุก Plant</option>
                    </select>
                </div>
                <button id="updateBtn" class="icon-btn" title="เปิด Google Sheet เพื่ออัปเดตข้อมูลคลัง" style="display:none;">
                    <i class="fas fa-database"></i>
                </button>
                <span id="lastUpdateLabel" style="font-size:12px;color:#555;margin-left:8px;"></span>
                <a id="uploadBtn" class="export-btn" href="#" target="_blank"
                    style="display:none; flex: 0 1 auto; margin-left: 0;"><i class="fas fa-upload"></i> Upload</a>
                <div class="control-group">
                    <label title="ระยะเวลาที่ใช้ในการจัดส่ง (Lead Time)"><i class="fas fa-clock control-icon"></i> Lead Time:</label>
                    <input type="number" id="leadTimeDays" value="15"><span class="unit">วัน</span>
                </div>
                <div class="control-group">
                    <label title="จำนวนวันที่สำรองเพื่อป้องกันความผันผวน (Safety Days)"><i class="fas fa-shield-alt control-icon"></i> Safety:</label>
                    <input type="number" id="safetyDays" value="5"><span class="unit">วัน</span>
                </div>
                <div class="control-group">
                    <label title="จำนวนวันที่ต้องการให้สต็อกครอบคลุมหลังสั่ง (Cover Days)"><i class="fas fa-calendar-check control-icon"></i> ครอบคลุม:</label>
                    <input type="number" id="coverDays" value="35"><span class="unit">วัน</span>
                </div>
            </div>
            <div class="search-row">
                <div class="control-group">
                    <label><i class="fas fa-search control-icon"></i> ค้นหา:</label>
                    <input type="text" id="searchInput" placeholder="Material หรือ Description">
                </div>
                <div id="responsibleFilterContainer">
                    <label title="กรองตามผู้รับคืน/เจ้าของ Shelf"><i class="fas fa-user-check control-icon"></i> ผู้รับคืน:</label>
                    <select id="responsibleFilter">
                        <option value="">ทุกคน</option>
                    </select>
                </div>
                <div class="control-group">
                    <label title="กรองตามสถานะวัสดุจากชีท Orders"><i class="fas fa-filter control-icon"></i> Filter:Status:</label>
                    <select id="statusFilter">
                        <option value="">ทุกสถานะ</option>
                        <option value="ไม่มีสถานะ">ไม่มีสถานะ</option>
                    </select>
                </div>
                <div class="control-group">
                    <label title="กรองตามความแตกต่างระหว่างสั่งจริง vs แนะนำสั่ง หรือสถานะนวนคร"><i class="fas fa-balance-scale control-icon"></i> Option:</label>
                    <select id="orderDiffFilter">
                        <option value="">ทั้งหมด</option>
                        <option value="less">สั่งจริง < แนะนำ</option>
                        <option value="equal">สั่งจริง = แนะนำ</option>
                        <option value="more">สั่งจริง > แนะนำ</option>
                        <option value="nav0">นวนคร = 0</option>
                        <option value="actualgt0">สั่งจริง > 0</option>
                        <option value="navgt0">นวนคร > 0</option>
                    </select>
                </div>

                <!-- ★ ปุ่มตะกร้ารวม -->
                <button class="icon-btn cart-main-btn" id="cartMainBtn" title="เปิดตะกร้าอะไหล่ (รวมรายการเพื่อพิมพ์ Label)">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cartCountBadge">0</span>
                </button>

                <button class="icon-btn" id="cartClearBtn" title="ล้างตะกร้าทั้งหมด">
                    <i class="fas fa-trash"></i>
                </button>

                <!-- ✅ ปุ่ม Set -->
                <button class="icon-btn set-btn" id="setActualBtn" title="ตั้ง “สั่งจริง” = “แนะนำสั่ง” สำหรับรายการในหน้าปัจจุบัน">
                    <i class="fas fa-check"></i>
                </button>

                <button class="export-btn" id="exportBtn" title="Export ข้อมูลที่แสดงเป็นไฟล์ CSV">
                    <i class="fas fa-file-export"></i> Export
                </button>
            </div>

            <div class="table-container" id="tableSection" style="display:none;">
                <table id="dataTable">
                    <thead>
                        <tr id="tableHeader">
                            <th style="width:50px;" title="เพิ่มรายการเข้า “ตะกร้า” เพื่อพิมพ์/สรุปการเบิก">Cart</th>
                            <th data-sort="Plant" title="รหัสคลังสินค้า (Plant) ที่กำลังดูข้อมูล">
                                Plant <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th data-sort="Material" title="รหัสอะไหล่/วัสดุ (Material Code)">
                                Material <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th title="ชื่อ/รายละเอียดอะไหล่จาก SAP (Material description)">รายการอะไหล่</th>
                            <th title="ตำแหน่งจัดเก็บ (Storage bin) จากข้อมูลคลัง">Storage bin</th>

                            <th data-sort="Navanakorn"
                                title="จำนวนคงเหลือของ Material เดียวกันในคลังนวนคร (Plant 0301) เพื่อดูว่าคลังกลางมีของไหม">
                                นวนคร
                            </th>
                            <th data-sort="Unrestricted"
                                title="คงเหลือใช้งานได้ (Unrestricted stock) ของคลังที่กำลังดู">
                                คงเหลือ <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th data-sort="Value"
                                title="มูลค่าสต๊อก: ถ้ามี AvgVal => คงเหลือ×AvgVal, ถ้าไม่มีใช้ Value Unrestricted จาก SAP">
                                มูลค่า <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th data-sort="Qty6Month"
                                title="ยอดเบิกย้อนหลัง 6 เดือน (จาก MoveAllsum). ถ้าไม่มีจะประมาณจาก 4M×1.5">
                                6M
                            </th>
                            <th data-sort="Qty4Month" title="ยอดเบิกย้อนหลัง 4 เดือน (ฐานหลักคำนวณ Avg/Day, Avg/Month)">
                                4M
                            </th>
                            <th data-sort="AvgMonthly" title="ค่าเฉลี่ยการเบิกต่อเดือน (AvgM) = Qty4Month ÷ 4">
                                AvgM
                            </th>
                            <th data-sort="ThirtyDay" title="ยอดเบิกจริงใน 30 วันล่าสุด (ช่วยจับความต้องการล่าสุด)">
                                30Day
                            </th>
                            <th data-sort="Mean"
                                title="ค่าเฉลี่ยรายเดือนแบบถ่วงน้ำหนัก (Mean) – ผสม 4M + 30Day ตาม Moving/ABC">
                                Mean
                            </th>
                            <th data-sort="SafetyStock"
                                title="Safety Stock = AvgDailyUse × SafetyDays (SafetyDays มาจากช่อง Safety)">
                                Safety
                            </th>
                            <th data-sort="ROP"
                                title="Reorder Point (ROP) = (AvgDailyUse × LeadTimeDays) + SafetyStock">
                                ROP <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th data-sort="DOS"
                                title="Days of Stock (DOS) = คงเหลือ ÷ AvgDailyUse (ถ้า AvgDailyUse=0 จะแสดง 'มาก')">
                                DOS
                            </th>
                            <th data-sort="RecommendedOrder"
                                title="จำนวนแนะนำสั่ง: ถ้าคงเหลือ < ROP => (AvgDailyUse×CoverDays) - คงเหลือ แล้วปัดตาม Pack">
                                แนะนำสั่ง <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th title="จำนวนสั่งจริงที่ผู้ใช้ปรับเอง (ระบบจะจำค่าไว้ในเครื่องด้วย LocalStorage)">
                                สั่งจริง
                            </th>
                            <th data-sort="Unit" title="หน่วยนับของวัสดุ (Base Unit of Measure เช่น Pc)">
                                หน่วย
                            </th>
                            <th title="หมายเหตุเพิ่มเติมจากข้อมูล mainsap (ใช้ช่วยตัดสินใจ)">หมายเหตุ</th>
                            <th data-sort="MultiplyUnit"
                                title="Pack/Package: จำนวนต่อแพ็คสำหรับปัดการสั่ง (เช่น 10 ชิ้น/แพ็ค)">
                                Package
                            </th>
                            <th data-sort="Product" title="กลุ่ม/ประเภทสินค้า (Product Group) จาก mainsap">
                                Product
                            </th>
                            <th data-sort="ABCValue"
                                title="ABC ตามมูลค่าสะสม (Pareto): A≤70%, B≤90%, C>90% (คำนวณใหม่ตามโหมด)">
                                ABC
                            </th>
                            <th data-sort="Moving"
                                title="ความเร็วการเคลื่อนไหวจาก AvgM: Dead=0, Slowly<0.7, Slow<12, Medium<30, Fast>=30">
                                Moving
                            </th>
                            <th data-sort="ReturnQty"
                                title="จำนวนส่งคืนได้ = max(0, คงเหลือ - KeepQty). KeepQty คำนวณจาก Moving + ABC">
                                จำนวนส่งคืน
                            </th>
                            <th data-sort="CumPercent"
                                title="เปอร์เซ็นต์มูลค่าสะสมของรายการนั้นในลำดับการจัด ABC">
                                %สะสม <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="col-location" title="Location จากข้อมูลจัดเก็บ (ถ้ามี) หรือใช้ Storage bin แทน">
                                Location</th>
                            <th class="col-shelf" title="Shelf = อักษร/รหัส 3 ตัวแรกของ Location (ใช้ map หาเจ้าของ)">
                                Shelf</th>
                            <th title="ผู้รับคืน/ผู้ดูแล Shelf (map จาก Shelf → UserID → ชื่อ)">ผู้รับคืน</th>
                            <th data-sort="Status" title="สถานะวัสดุ/คำสั่ง (ดึงจากชีท Orders เช่น pending/approved)">
                                Status
                            </th>
                        </tr>
                    </thead>
                    <tbody id="dataList"></tbody>
                </table>
            </div>

            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" style="display:none;">
        <div class="login-form">
            <h2>Login</h2>
            
            <form id="loginForm">
                <input type="text" id="idUserInput" placeholder="IDUser" autocomplete="username">
                <input type="password" id="passwordInput" placeholder="Password" autocomplete="current-password">
                <label><input type="checkbox" id="rememberMe"> จดจำฉัน</label>
                <button type="submit" id="loginBtn">เข้าสู่ระบบ</button>
            </form>
            
            <div id="loginError"></div>
        </div>
    </div>

    <!-- =========================
         ✅ HELP MODAL (อธิบายโปรแกรม) – เวอร์ชันสมบูรณ์ + title ในทุกองค์ประกอบ
         ========================= -->
    <div id="helpModal" class="help-modal">
        <div class="help-content">
            <div class="help-header">
                <h2><i class="fas fa-circle-info"></i> คู่มือระบบ ABC Analysis & Smart Ordering</h2>
                <button class="help-close-btn" id="helpCloseBtn" title="ปิด"><i class="fas fa-xmark"></i></button>
            </div>
            <div class="help-body">
                <div class="help-grid">
                    <div class="help-card">
                        <h3><span class="help-pill">เป้าหมายของระบบ</span></h3>
                        <ul>
                            <li>จัดกลุ่มอะไหล่ตามมูลค่า <b>ABC</b> (A=สำคัญมาก, B=รองลงมา, C=ทั่วไป)</li>
                            <li>วิเคราะห์ความเร็วการเคลื่อนไหว <b>Moving</b> (Fast/Medium/Slow/Slowly/Dead)</li>
                            <li>คำนวณ <b>“แนะนำสั่ง”</b> อัตโนมัติ เพื่อป้องกันของขาดและลดของเกิน</li>
                            <li>ช่วยตัดสินใจด้วย ROP, Safety Stock, DOS และตัวกรองต่าง ๆ</li>
                        </ul>
                    </div>
                    <div class="help-card">
                        <h3><span class="help-pill">ข้อมูลหลักที่ใช้คำนวณ</span></h3>
                        <ul>
                            <li><b>Qty4Month</b> → ยอดเบิก 4 เดือน (120 วัน) – ข้อมูลนิ่ง</li>
                            <li><b>ThirtyDay (30Day)</b> → ยอดเบิก 30 วันล่าสุด – ข้อมูลสด</li>
                            <li><b>Unrestricted</b> → คงเหลือปัจจุบัน</li>
                            <li><b>AvgVal</b> → ราคาเฉลี่ยต่อชิ้น (คำนวณมูลค่าให้แม่นยำ)</li>
                            <li><b>MultiplyUnit</b> → ขนาดแพ็ค (ใช้ปัดจำนวนสั่ง)</li>
                        </ul>
                    </div>
                </div>

                <h3>ความหมายคอลัมน์สำคัญ</h3>
                <ul>
                    <li><b>AvgM (AvgMonthly)</b> → เฉลี่ยต่อเดือนจาก 4 เดือน (Qty4Month ÷ 4) – ใช้จัด Moving</li>
                    <li><b>30Day</b> → ยอดเบิก 30 วันล่าสุด</li>
                    <li><b>Mean</b> → ค่าเฉลี่ยรายเดือนแบบถ่วงน้ำหนัก (ผสม AvgM จาก 4M + 30Day) – ใช้เป็นฐานคำนวณสต็อก</li>
                    <li><b>Safety</b> → Safety Stock (สำรองกันผันผวน)</li>
                    <li><b>ROP</b> → Reorder Point (จุดที่ควรสั่งซื้อ)</li>
                    <li><b>DOS</b> → Days of Supply (คงเหลือเพียงพออีกกี่วัน)</li>
                    <li><b>แนะนำสั่ง</b> → จำนวนที่ระบบแนะนำ (ปัดตามแพ็คแล้ว)</li>
                    <li><b>สั่งจริง</b> → จำนวนที่คุณแก้ไขเอง (ระบบจะจำค่าที่แก้)</li>
                </ul>

                <h3>การจัดกลุ่ม Moving (จาก AvgMonthly)</h3>
                <ul>
                    <li><b>Dead</b>: 0</li>
                    <li><b>Slowly</b>: น้อยกว่า 0.7 ชิ้น/เดือน</li>
                    <li><b>Slow</b>: 0.7 – น้อยกว่า 12 ชิ้น/เดือน</li>
                    <li><b>Medium</b>: 12 – น้อยกว่า 30 ชิ้น/เดือน</li>
                    <li><b>Fast</b>: 30 ชิ้น/เดือนขึ้นไป</li>
                </ul>

                <h3>สูตรคำนวณ Mean (ค่าเฉลี่ยรายเดือนแบบถ่วงน้ำหนัก) – ละเอียด</h3>
                <p>Mean คือค่าเฉลี่ยที่ผสมข้อมูล 4 เดือน (นิ่ง) + 30 วันล่าสุด (สด) เพื่อให้ทั้งน่าเชื่อถือและทันสมัย</p>
                <ol>
                    <li><b>คำนวณค่าเฉลี่ยพื้นฐาน</b><br>
                        • avgMonthlyFrom4m = Qty4Month ÷ 4<br>
                        • avgMonthlyFrom30d = ThirtyDay (30 วัน ≈ 1 เดือน)</li>
                    <li><b>กำหนดน้ำหนักเริ่มต้น</b><br>
                        w4m = 0.70, w30 = 0.30 (ให้ข้อมูลเก่าหนักกว่าเพื่อความนิ่ง)</li>
                    <li><b>ปรับน้ำหนักตาม Moving</b><br>
                        • Fast → w4m=0.50, w30=0.50<br>
                        • Medium → w4m=0.60, w30=0.40<br>
                        • Slow → w4m=0.80, w30=0.20<br>
                        • Slowly/Dead → w4m=0.90, w30=0.10</li>
                    <li><b>ปรับเพิ่มตาม ABC</b><br>
                        • ABC A → ลด w4m ลง 0.05 (ฟัง 30Day มากขึ้น)<br>
                        • ABC C → เพิ่ม w4m ขึ้น 0.05 (ฟัง 4M มากขึ้น)</li>
                    <li><b>ป้องกัน Outlier</b><br>
                        ถ้า avgMonthlyFrom30d > avgMonthlyFrom4m × 3 → จำกัดให้ใช้ค่าสูงสุด = avgMonthlyFrom4m × 3</li>
                    <li><b>คำนวณ Mean สุดท้าย</b><br>
                        Mean = (avgMonthlyFrom4m × w4m) + (avgMonthlyFrom30d ที่ผ่าน guard × w30)</li>
                </ol>
                <p><small>ผลลัพธ์: Fast + ABC A จะได้ Mean ที่ตอบสนองต่อแนวโน้มล่าสุดเร็ว<br>Slow + ABC C จะได้ Mean ที่นิ่งและยึดข้อมูลเก่าเป็นหลัก</small></p>

                <h3>กฎการแนะนำสั่ง (RecommendedOrder) – ลำดับขั้นตอนจริงในโค้ด</h3>
                <ol>
                    <li><b>คำนวณ AvgDailyUse</b> โดยถ่วงน้ำหนักระหว่างข้อมูล 4 เดือน + 30 วัน<br>
                        <small>(Fast/ABC A จะให้น้ำหนัก 30Day มากกว่า, Slow/C จะให้น้ำหนัก 4M มากกว่า)</small></li>
                    <li><b>ป้องกัน Outlier</b> → ถ้า 30Day พุ่งสูงผิดปกติ จะจำกัดไม่ให้เกิน 4M × 3 เท่า</li>
                    <li><b>Seasonal Boost</b> → ถ้า 30Day สูงกว่า 4M มาก (ช่วงพีค) จะเพิ่มน้ำหนัก 30Day ชั่วคราว</li>
                    <li><b>Stockout Protection</b> → ถ้าคงเหลือ = 0 และเป็น Fast/Medium จะเพิ่ม Safety Days ชั่วคราว</li>
                    <li><b>คำนวณ ROP</b> = (AvgDailyUse × LeadTime 5 วัน) + SafetyStock</li>
                    <li><b>ถ้าคงเหลือ < ROP</b> → แนะนำสั่งให้ครอบคลุม CoverDays (40 วัน)<br>
                        <small>จำนวน = (AvgDailyUse × 40) - คงเหลือ</small></li>
                    <li><b>ถ้าคงเหลือ ≥ ROP</b> → แนะนำสั่ง = 0</li>
                    <li><b>ปัดจำนวนสั่ง</b> ตาม MultiplyUnit (ถ้ามี) เพื่อให้สั่งตามแพ็คจริง</li>
                    <li><b>กฎตัดสั่งพิเศษ (ใช้เฉพาะ Slow / Slowly เท่านั้น)</b>
                        <ul>
                            <li>ถ้า Mean = 0 → ไม่สั่ง</li>
                            <li>ถ้า 30Day = 0 → ไม่สั่ง</li>
                            <li>ถ้า 30Day ≥ Qty4Month และเป็น Slowly → ไม่สั่ง</li>
                        </ul>
                        <small>หมายเหตุ: Fast / Medium / Dead จะยังสั่งตามปกติแม้ 30Day = 0 ถ้า Mean > 0</small></li>
                </ol>

                <h3>เคล็ดลับการใช้งาน</h3>
                <ul>
                    <li>ปรับค่า <b>LeadTime / Safety Days / Cover Days</b> เพื่อควบคุมความเข้มงวดของการสั่ง</li>
                    <li>ใช้ปุ่ม <b>“ตั้งตามแนะนำ”</b> เพื่อนำค่าแนะนำไปใส่ “สั่งจริง” ในหน้าปัจจุบัน</li>
                    <li>กรองด้วย <b>Moving / ABC / ผู้รับคืน / Status</b> เพื่อดูกลุ่มที่ต้องการ</li>
                    <li>ใช้ <b>ตะกร้า</b> เพิ่มรายการแล้วพิมพ์ Label ให้ช่างได้ทันที</li>
                    <li>กด <b>Export CSV</b> เพื่อนำข้อมูลไปวิเคราะห์ต่อ</li>
                </ul>

                <h3><i class="fas fa-exclamation-triangle" style="color:#e74c3c;"></i> คำเตือน: การรีเซ็ตข้อมูล “สั่งจริง” (ActualOrder)</h3>
                <p>ข้อมูล “สั่งจริง” ที่คุณกรอกหรือแก้ไขเอง <b>จะถูกบันทึกถาวรในเบราว์เซอร์</b> และ <b>ไม่ถูกรีเซ็ตอัตโนมัติ</b> ในกรณีปกติ</p>
                <p>แต่ข้อมูลจะถูก <b>รีเซ็ต (ทับด้วยค่า “แนะนำสั่ง” ใหม่)</b> หากเกิดอย่างใดอย่างหนึ่งต่อไปนี้:</p>
                <ul style="color:#e67e22; font-weight:bold;">
                    <li>คุณ <b>รีเฟรชหน้าเว็บ</b> หรือ <b>โหลดข้อมูล Plant ใหม่</b>  
                        <small style="color:#7f8c8d; font-weight:normal;">(เฉพาะรายการที่คุณ <u>ยังไม่เคยแก้ “สั่งจริง”</u> เท่านั้นที่จะถูกรีเซ็ต  
                        รายการที่เคยแก้แล้วจะดึงค่าจากเบราว์เซอร์กลับมา)</small></li>
                    <li>คุณ <b>กดปุ่ม “ตั้งตามแนะนำ”</b>  
                        <small style="color:#7f8c8d; font-weight:normal;">(จะตั้ง “สั่งจริง” = “แนะนำสั่ง” เฉพาะรายการในหน้าปัจจุบัน และบันทึกค่านี้ถาวร)</small></li>
                    <li>คุณ <b>ล้างข้อมูลเบราว์เซอร์</b> (Clear browsing data / localStorage)  
                        <small style="color:#7f8c8d; font-weight:normal;">(ข้อมูล “สั่งจริง” ทั้งหมดจะหายไป ระบบจะเริ่มต้นใหม่ตาม “แนะนำสั่ง”)</small></li>
                </ul>
                <p><b>คำแนะนำ:</b><br>
                   • ถ้าต้องการให้ค่าที่กรอก “ติดถาวร” → แก้ไขช่อง “สั่งจริง” อย่างน้อย 1 ครั้ง ระบบจะบันทึกอัตโนมัติ<br>
                   • หากต้องการรีเซ็ตทั้งหมด → ล้างข้อมูลเบราว์เซอร์ หรือรอข้อมูลสต็อกอัปเดตครั้งใหญ่</p> 

                <p style="text-align:center;color:#7f8c8d;font-size:0.9em;margin-top:20px;">
                    อัปเดตตามโค้ดล่าสุด – เน้นความสมดุลระหว่าง “กันของขาด” และ “ไม่ให้ของเกิน”<br>
                    ปรับแต่งเพิ่มเติมได้ตามความต้องการของ Plant
                </p>
            </div>
        </div>
    </div>

    <!-- ★ Cart Modal -->
    <div id="cartModal" class="cart-modal">
        <div class="cart-modal-content" id="cartModalPrintArea">
            <div class="cart-modal-header">
                <h2><i class="fas fa-shopping-cart"></i> ตะกร้าอะไหล่</h2>
                <div class="cart-emp-input">
                    <label>
                        รหัสพนักงาน:
                        <input type="text" id="employeeCode" placeholder="กรอกรหัสพนักงาน">
                    </label>
                    <!-- ★ แสดงชื่อและทีมที่ดึงจาก Employee sheet -->
                    <div class="cart-emp-info">
                        <span id="employeeNameLabel"></span>
                        <span id="employeeTeamLabel"></span>
                    </div>
                </div>
            </div>

            <div class="cart-modal-body">
                <table class="cart-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Material</th>
                            <th>รายการอะไหล่</th>
                            <th>Storage bin</th>
                            <th>จำนวน</th>
                            <th>Pack</th>
                        </tr>
                    </thead>
                    <tbody id="cartTableBody">
                        <!-- เติมด้วย JS -->
                    </tbody>
                </table>
            </div>
            <div class="cart-modal-footer">
                <button class="export-btn" id="cartPrintBtn"><i class="fas fa-print"></i> Print</button>
                <button class="export-btn" id="cartCloseBtn"
                    style="background:linear-gradient(135deg,#e74c3c,#c0392b);"><i class="fas fa-times"></i>
                    ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <!-- ✨ JS หลักของระบบ (แยกไฟล์แล้ว) -->
    <script src="app.js"></script>
</body>

</html>
