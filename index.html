<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>วิเคราะห์ ABC อะไหล่ (เรียงลำดับได้)</title>
    <style>
        body { font-family: Tahoma, Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        h1 { color: #2c3e50; text-align: center; }
        .filters { padding: 15px; background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
        select { padding: 10px 15px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; margin: 0 10px; }

        /* ปุ่ม Export */
        .btn-export {
            padding: 10px 18px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            margin-left: 10px;
            cursor: pointer;
            background: #27ae60;
            color: white;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .btn-export:hover {
            background: #1e8449;
        }

        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
        th { background: #3498db; color: white; padding: 15px; cursor: pointer; user-select: none; position: relative; text-align: center; }
        th:hover { background: #2980b9; }
        th::after { content: " ↕"; opacity: 0.5; }
        th.asc::after { content: " ▲"; opacity: 1; font-weight: bold; }
        th.desc::after { content: " ▼"; opacity: 1; font-weight: bold; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }

        /* คอลัมน์ รายการอะไหล่ ให้ชิดซ้าย */
        .td-left { text-align: left !important; }

        tr:nth-child(even) { background: #f8fbff; }
        .abc-fast { background: #e74c3c !important; color: white; font-weight: bold; }
        .abc-medium { background: #f39c12 !important; color: white; }
        .abc-slow { background: #95a5a6 !important; color: white; }
        .abc-dead { background: #34495e !important; color: white; }
    </style>
</head>
<body>

    <h1>วิเคราะห์ ABC อะไหล่ (Fast / Medium / Slow / Dead)</h1>

    <div class="filters">
        <label>กรอง Plant :</label>
        <select id="plantFilter">
            <option value="">ทุก Plant</option>
        </select>

        <label>กรอง ABC :</label>
        <select id="abcFilter">
            <option value="">ทุกประเภท</option>
            <option value="Fast">Fast (>30 ชิ้น/เดือน)</option>
            <option value="Medium">Medium (13–30 ชิ้น/เดือน)</option>
            <option value="Slow">Slow (1–12 ชิ้น/เดือน)</option>
            <option value="Dead">Dead (0 ชิ้น/เดือน)</option>
        </select>

        <!-- ปุ่ม Export Excel -->
        <button id="exportBtn" class="btn-export">ส่งออกเป็น Excel</button>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
                <th data-col="Plant">Plant</th>
                <th data-col="Material">Material</th>
                <th data-col="Description">รายการอะไหล่</th>
                <th data-col="Unit">หน่วย</th>
                <th data-col="Unrestricted">คงเหลือ (ชิ้น)</th>
                <th data-col="Value">มูลค่าคงเหลือ (บาท)</th>
                <th data-col="SixMonth">ใช้ 6 เดือน</th>
                <th data-col="Qtyissu">ใช้ 4 เดือน</th>
                <th data-col="ABC">ABC</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const usageUrl = 'https://opensheet.elk.sh/1P8Frv1zvcuO3qt8seU-zMF0FV0TQHyKXLn9GNHVr6kI/MoveAllsum';
        const inventoryUrl = 'https://opensheet.elk.sh/1OtcgbmQdrI3gKJCGiDge6xuOsrT0GPxdKeFPjpvK3Rg/Sheet1';

        function toNumber(val) {
            if (!val) return 0;
            const num = parseFloat(val.toString().replace(/,/g, ''));
            return isNaN(num) ? 0 : num;
        }

        function formatNumber(n) {
            return Number(n).toLocaleString('th-TH');
        }

        function formatCurrency(n) {
            return Number(n).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        let allData = [];
        let currentSort = { col: '', dir: '' };
        let currentViewData = []; // เก็บข้อมูลที่กำลังแสดงในตาราง (หลังกรอง/เรียงแล้ว)

        async function loadData() {
            try {
                const [uRes, iRes] = await Promise.all([fetch(usageUrl), fetch(inventoryUrl)]);
                const usage = await uRes.json();
                const inv = await iRes.json();

                const usageMap = new Map();
                usage.forEach(r => {
                    const key = `${r.Plant?.trim()}-${r.Material?.trim()}`;
                    usageMap.set(key, r);
                });

                const plants = new Set();

                allData = inv.map(row => {
                    const key = `${row.Plant?.trim()}-${row.Material?.trim()}`;
                    const u = usageMap.get(key) || { '6Mount': 0, Qtyissu: 0 };

                    const qty4m = toNumber(u.Qtyissu);
                    const monthly = qty4m / 4;

                    let abc = 'Dead';
                    if (monthly > 30) abc = 'Fast';
                    else if (monthly > 12) abc = 'Medium';
                    else if (monthly > 0) abc = 'Slow';

                    plants.add(row.Plant?.trim());

                    return {
                        Plant: row.Plant?.trim() || '',
                        Material: row.Material?.trim() || '',
                        Description: row['Material description'] || '',
                        Unit: row['Base Unit of Measure'] || '',
                        Unrestricted: toNumber(row.Unrestricted),
                        Value: toNumber(row['Value Unrestricted']),
                        SixMonth: toNumber(u['6Mount']),
                        Qtyissu: qty4m,
                        ABC: abc
                    };
                });

                const sortedPlants = Array.from(plants).sort();
                sortedPlants.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p;
                    opt.textContent = p;
                    document.getElementById('plantFilter').appendChild(opt);
                });

                applyFiltersAndSort();

            } catch (err) {
                alert('โหลดข้อมูลไม่สำเร็จ กรุณาตรวจสอบอินเทอร์เน็ต');
                console.error(err);
            }
        }

        function applyFiltersAndSort() {
            let data = [...allData];

            const plant = document.getElementById('plantFilter').value;
            const abc = document.getElementById('abcFilter').value;
            if (plant) data = data.filter(r => r.Plant === plant);
            if (abc) data = data.filter(r => r.ABC === abc);

            if (currentSort.col) {
                data.sort((a, b) => {
                    let A = a[currentSort.col];
                    let B = b[currentSort.col];

                    if (typeof A === 'string') A = A.toLowerCase();
                    if (typeof B === 'string') B = B.toLowerCase();

                    if (A < B) return currentSort.dir === 'asc' ? -1 : 1;
                    if (A > B) return currentSort.dir === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // เก็บข้อมูลชุดที่กำลังใช้แสดง
            currentViewData = data;

            renderTable(data);
        }

        function renderTable(data) {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                if (row.ABC === 'Fast') tr.classList.add('abc-fast');
                else if (row.ABC === 'Medium') tr.classList.add('abc-medium');
                else if (row.ABC === 'Slow') tr.classList.add('abc-slow');
                else tr.classList.add('abc-dead');

                const cols = [
                    row.Plant,
                    row.Material,
                    row.Description,
                    row.Unit,
                    formatNumber(row.Unrestricted),
                    formatCurrency(row.Value),
                    formatNumber(row.SixMonth),
                    formatNumber(row.Qtyissu),
                    row.ABC
                ];

                cols.forEach((text, index) => {
                    const td = document.createElement('td');
                    td.innerHTML = text;

                    // คอลัมน์ รายการอะไหล่ (index 2) ชิดซ้าย
                    if (index === 2) td.classList.add('td-left');

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        // ฟังก์ชันส่งออกเป็น CSV (เปิดด้วย Excel ได้)
        function exportToExcel() {
            if (!currentViewData || currentViewData.length === 0) {
                alert('ไม่มีข้อมูลสำหรับส่งออก');
                return;
            }

            const header = [
                'Plant',
                'Material',
                'รายการอะไหล่',
                'หน่วย',
                'คงเหลือ (ชิ้น)',
                'มูลค่าคงเหลือ (บาท)',
                'ใช้ 6 เดือน',
                'ใช้ 4 เดือน',
                'ABC'
            ];

            const rows = currentViewData.map(row => [
                row.Plant,
                row.Material,
                row.Description,
                row.Unit,
                row.Unrestricted,   // ใช้ค่าดิบ (ไม่ใส่ comma)
                row.Value,
                row.SixMonth,
                row.Qtyissu,
                row.ABC
            ]);

            const csvArray = [header, ...rows];

            const csvContent = csvArray.map(cols => 
                cols.map(val => {
                    if (val === null || val === undefined) return '';
                    let s = val.toString();
                    // escape " และ , และ newline
                    if (s.includes('"')) s = s.replace(/"/g, '""');
                    if (s.search(/("|,|\n)/g) >= 0) s = `"${s}"`;
                    return s;
                }).join(',')
            ).join('\r\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ABC_SpareParts.csv'; // เปิดด้วย Excel ได้เลย
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // คลิกหัวตารางเพื่อ sort
        document.querySelectorAll('th').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.getAttribute('data-col');

                if (currentSort.col === col) {
                    currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort = { col: col, dir: 'asc' };
                }

                document.querySelectorAll('th').forEach(h => {
                    h.classList.remove('asc', 'desc');
                });

                th.classList.add(currentSort.dir);

                applyFiltersAndSort();
            });
        });

        document.getElementById('plantFilter').addEventListener('change', applyFiltersAndSort);
        document.getElementById('abcFilter').addEventListener('change', applyFiltersAndSort);

        // ปุ่ม Export
        document.getElementById('exportBtn').addEventListener('click', exportToExcel);

        // เริ่มโหลดข้อมูล
        loadData();
    </script>
</body>
</html>
